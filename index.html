<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokuz Taş - Resmî Kurallar (AI Rakip)</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --line:#93a4ff55; --text:#e9edff; --muted:#b9c2ff; --accent:#7aa2ff; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ display:flex; flex-direction:column; gap:12px; padding:14px; max-width:1040px; margin:0 auto; }
    .top{ display:flex; flex-wrap:wrap; gap:12px; align-items:stretch; }
    .card{ background:var(--panel); border:1px solid #2a3570; border-radius:14px; padding:12px; }
    .boardCard{ flex: 1 1 560px; display:flex; align-items:center; justify-content:center; }
    .infoCard{ flex: 1 1 340px; min-width:320px; }
    h1{ font-size:18px; margin:0 0 8px 0; font-weight:800; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button{
      border:1px solid #2a3570; background:#0f1630; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:750;
    }
    button:hover{ border-color:#4052b6; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    input{
      width:100%; box-sizing:border-box;
      border:1px solid #2a3570; background:#0f1630; color:var(--text);
      padding:12px; border-radius:12px;
    }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#0f1630; border:1px solid #2a3570; color:var(--muted); font-size:12px; }
    .status{ margin-top:10px; line-height:1.35; color:var(--muted); min-height:42px; }
    .hint{ margin-top:10px; font-size:12px; color:#c9d0ff; opacity:.9; }
    .kpi{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
    .kpi div{ background:#0f1630; border:1px solid #2a3570; border-radius:12px; padding:10px; font-size:13px; color:var(--muted); }
    .kpi b{ color:var(--text); }
    .small{ font-size:12px; color:var(--muted); }
    svg{ width:min(88vw, 600px); height:auto; }
    .line{ stroke:var(--line); stroke-width:8; stroke-linecap:round; }
    .pos{ fill:#0f1630; stroke:#2a3570; stroke-width:3; }
    .pos:hover{ stroke:#6e84ff; }
    .pos.empty{ cursor:pointer; }
    .stoneW{ fill:#e9edff; stroke:#bfc8ff; stroke-width:3; }
    .stoneB{ fill:#121a33; stroke:#7aa2ff; stroke-width:3; }
    .sel{ stroke:#ffd166; stroke-width:5; }
    .glow{ filter:url(#glow); }
    .divider{ height:1px; background:#24306a; margin:10px 0; }
  </style>
</head>
<body>
<div class="wrap">

  <!-- GİRİŞ (KAYIT) -->
  <div class="card" id="loginCard">
    <h1>Oyuna Giriş</h1>
    <div class="small">Ad Soyad + Sınıf/Şube girince kayıt düşer ve oyun açılır.</div>
    <div style="height:10px"></div>
    <label class="small">Ad Soyad</label>
    <input id="name" placeholder="Örn: Ayşe Yılmaz" autocomplete="name"/>
    <div style="height:10px"></div>
    <label class="small">Sınıf / Şube</label>
    <input id="classroom" placeholder="Örn: 5/A"/>
    <div style="height:10px"></div>
    <button id="startBtn">Başla</button>
    <div class="status" id="loginMsg"></div>
  </div>

  <!-- OYUN -->
  <div class="top" id="gameUI" style="display:none">
    <div class="card boardCard">
      <svg viewBox="0 0 1000 1000" aria-label="Dokuz taş tahtası">
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>

        <!-- Squares -->
        <rect x="100" y="100" width="800" height="800" fill="none" class="line"/>
        <rect x="250" y="250" width="500" height="500" fill="none" class="line"/>
        <rect x="400" y="400" width="200" height="200" fill="none" class="line"/>

        <!-- Connectors -->
        <line x1="500" y1="100" x2="500" y2="400" class="line"/>
        <line x1="500" y1="600" x2="500" y2="900" class="line"/>
        <line x1="100" y1="500" x2="400" y2="500" class="line"/>
        <line x1="600" y1="500" x2="900" y2="500" class="line"/>

        <g id="positions"></g>
      </svg>
    </div>

    <div class="card infoCard">
      <h1>Dokuz Taş (Resmî) – Tek Cihaz / AI Rakip</h1>
      <div class="row">
        <span class="pill">Sen: Beyaz</span>
        <span class="pill">Rakip: Siyah (AI)</span>
        <span class="pill" id="phasePill">Aşama: Taş koyma</span>
      </div>

      <div class="kpi">
        <div>Sen: Tahtada <b id="wOnBoard">0</b> / Yerleşen <b id="wPlaced">0</b></div>
        <div>AI: Tahtada <b id="bOnBoard">0</b> / Yerleşen <b id="bPlaced">0</b></div>
      </div>

      <div class="status" id="status"></div>

      <div class="row" style="margin-top:10px;">
        <button id="newBtn">Yeni Oyun</button>
        <button id="undoBtn">Geri Al</button>
        <button id="hintBtn">İpucu</button>
      </div>

      <div class="divider"></div>

      <div class="hint">
        <div class="small">Kısa kullanım:</div>
        <ul class="small" style="margin:6px 0 0 18px; padding:0;">
          <li><b>Taş koyma:</b> boş noktaya dokun.</li>
          <li><b>Hareket:</b> kendi taşına dokun → komşu boş noktaya dokun.</li>
          <li><b>Uçma:</b> 3 taş kalınca istediğin boş noktaya gidebilirsin.</li>
          <li><b>Değirmen:</b> 3’lü yapınca rakipten 1 taş kaldırırsın (mümkünse değirmende olmayan).</li>
        </ul>
      </div>

      <div class="small" style="margin-top:10px; opacity:.85;">
        Not: Bu sürüm tek cihazda çalışır, rakip hamleleri otomatik üretir (AI).
      </div>
    </div>
  </div>
</div>

<script type="module">
/* ========= Firebase (kayıt) ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYzorBVSTCcE3xzDZ9PyPprBdYEzKov3c",
  authDomain: "oyun-3bfba.firebaseapp.com",
  projectId: "oyun-3bfba",
  storageBucket: "oyun-3bfba.firebasestorage.app",
  messagingSenderId: "120738565998",
  appId: "1:120738565998:web:81876d89cafa64a1207b7f"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = s => document.querySelector(s);
const setLoginMsg = (t)=> $("#loginMsg").textContent = t;

/* ========= Oyun verileri ========= */
const POS = [
  [100,100],[500,100],[900,100],
  [250,250],[500,250],[750,250],
  [400,400],[500,400],[600,400],
  [100,500],[250,500],[400,500],[600,500],[750,500],[900,500],
  [400,600],[500,600],[600,600],
  [250,750],[500,750],[750,750],
  [100,900],[500,900],[900,900]
];

const ADJ = [
  [1,9],
  [0,2,4],
  [1,14],
  [4,10],
  [1,3,5,7],
  [4,13],
  [7,11],
  [4,6,8],
  [7,12],
  [0,10,21],
  [3,9,11,18],
  [6,10,15],
  [8,13,17],
  [5,12,14,20],
  [2,13,23],
  [11,16],
  [15,17,19],
  [12,16],
  [10,19],
  [16,18,20,22],
  [13,19],
  [9,22],
  [19,21,23],
  [14,22]
];

const MILLS = [
  [0,1,2],[3,4,5],[6,7,8],
  [9,10,11],[12,13,14],[15,16,17],
  [18,19,20],[21,22,23],
  [0,9,21],[3,10,18],[6,11,15],
  [1,4,7],[16,19,22],[8,12,17],
  [5,13,20],[2,14,23]
];

const positionsG = document.getElementById("positions");

let game, history = [];

function newGame(){
  game = {
    board: Array(24).fill(null),
    turn: 'W', // W: insan, B: AI
    placed: {W:0, B:0},
    captureMode: false,
    pendingMover: null,
    winner: null,
    _temp: null
  };
  history = [];
  pushHistory();
  render();
  setStatus("Sıra sende. Boş bir noktaya taş koy.");
}

function pushHistory(){
  history.push(JSON.parse(JSON.stringify(game)));
  $("#undoBtn").disabled = history.length <= 1;
}

function undo(){
  if(history.length <= 1) return;
  history.pop();
  game = JSON.parse(JSON.stringify(history[history.length-1]));
  render();
  setStatus("Geri alındı. Sıra: " + (game.turn==='W' ? "Sen" : "AI"));
}

function countOnBoard(board, p){ return board.filter(x=>x===p).length; }
function phaseOf(state, p){ return state.placed[p] < 9 ? "placing" : "moving"; }
function canFly(state, p){ return phaseOf(state,p)==="moving" && countOnBoard(state.board,p) <= 3; }

function millsFormedBy(board, p, posIndex){
  return MILLS.filter(m => m.includes(posIndex) && m.every(i => board[i]===p));
}
function isInAnyMill(board, opponent, idx){
  return MILLS.some(m => m.includes(idx) && m.every(i => board[i]===opponent));
}
function removableOpponentStones(board, opponent){
  const oppIdx = board.map((v,i)=> v===opponent ? i : -1).filter(i=>i>=0);
  const notInMill = oppIdx.filter(i => !isInAnyMill(board, opponent, i));
  return notInMill.length ? notInMill : oppIdx;
}

function hasAnyLegalMove(state, p){
  const b = state.board;
  if(phaseOf(state,p)==="placing") return b.some(x=>x===null);
  const fly = canFly(state,p);
  const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);
  if(fly){
    return b.some(x=>x===null) && my.length>0;
  }
  for(const from of my){
    if(ADJ[from].some(to => b[to]===null)) return true;
  }
  return false;
}

function checkWinner(state){
  const wCount = countOnBoard(state.board,'W');
  const bCount = countOnBoard(state.board,'B');
  if(state.placed.W>=9 && (wCount<3 || !hasAnyLegalMove(state,'W'))) return 'B';
  if(state.placed.B>=9 && (bCount<3 || !hasAnyLegalMove(state,'B'))) return 'W';
  return null;
}

/* ====== AI: hareket üretme + minimax ====== */
function generateActions(state, p){
  const opp = p==='W' ? 'B' : 'W';
  const actions = [];
  const board = state.board;
  const phase = phaseOf(state,p);

  const addCaptureVariants = (boardAfter, moveObj) => {
    if(!moveObj.millMade){
      actions.push({...moveObj, capture: null});
      return;
    }
    const removable = removableOpponentStones(boardAfter, opp);
    for(const cap of removable){
      actions.push({...moveObj, capture: cap});
    }
  };

  if(phase==="placing"){
    for(let to=0; to<24; to++){
      if(board[to]!==null) continue;
      const b2 = board.slice();
      b2[to]=p;
      const millMade = millsFormedBy(b2,p,to).length>0;
      addCaptureVariants(b2, {type:'place', from:null, to, millMade});
    }
    return actions;
  }

  const fly = canFly(state,p);
  const my = board.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);

  for(const from of my){
    const targets = fly
      ? board.map((v,i)=> v===null ? i : -1).filter(i=>i>=0)
      : ADJ[from].filter(to => board[to]===null);

    for(const to of targets){
      const b2 = board.slice();
      b2[from]=null; b2[to]=p;
      const millMade = millsFormedBy(b2,p,to).length>0;
      addCaptureVariants(b2, {type:'move', from, to, millMade});
    }
  }
  return actions;
}

function applyAction(state, p, action){
  const opp = p==='W' ? 'B' : 'W';
  const s = JSON.parse(JSON.stringify(state));
  const b = s.board;

  if(action.type==='place'){
    b[action.to]=p;
    s.placed[p]+=1;
  }else{
    b[action.from]=null;
    b[action.to]=p;
  }

  if(action.capture!==null && action.capture!==undefined){
    if(b[action.capture]===opp) b[action.capture]=null;
  }

  s.turn = opp;
  s.pendingMover = null;
  s.captureMode = false;
  s._temp = null;

  s.winner = checkWinner(s);
  return s;
}

function evalState(state){
  const b = state.board;
  const w = countOnBoard(b,'W');
  const bl = countOnBoard(b,'B');
  const material = (bl - w) * 100;

  const millsW = MILLS.filter(m => m.every(i => b[i]==='W')).length;
  const millsB = MILLS.filter(m => m.every(i => b[i]==='B')).length;
  const millsScore = (millsB - millsW) * 60;

  const pot = (p)=>{
    let c=0;
    for(const m of MILLS){
      const vals = m.map(i=>b[i]);
      const cntP = vals.filter(v=>v===p).length;
      const cntE = vals.filter(v=>v===null).length;
      if(cntP===2 && cntE===1) c++;
    }
    return c;
  };
  const potScore = (pot('B') - pot('W')) * 18;

  const mob = (p)=>{
    const phase = phaseOf(state,p);
    if(phase==="placing") return 0;
    const fly = canFly(state,p);
    if(fly) return b.filter(v=>v===null).length;
    let moves=0;
    for(let i=0;i<24;i++){
      if(b[i]!==p) continue;
      moves += ADJ[i].filter(j=>b[j]===null).length;
    }
    return moves;
  };
  const mobScore = (mob('B') - mob('W')) * 4;

  if(state.winner==='B') return 1e9;
  if(state.winner==='W') return -1e9;

  return material + millsScore + potScore + mobScore;
}

function minimax(state, depth, alpha, beta, maximizingForB){
  if(depth===0 || state.winner) return {score: evalState(state), action: null};

  const p = maximizingForB ? 'B' : 'W';
  const actions = generateActions(state, p);
  if(!actions.length) return {score: evalState(state), action: null};

  actions.sort((a,b)=>{
    const sa = (a.millMade?50:0) + (a.capture!=null?30:0);
    const sb = (b.millMade?50:0) + (b.capture!=null?30:0);
    return sb-sa;
  });

  let bestAction = null;

  if(maximizingForB){
    let best = -Infinity;
    for(const act of actions){
      const next = applyAction(state, 'B', act);
      const res = minimax(next, depth-1, alpha, beta, false);
      if(res.score > best){ best = res.score; bestAction = act; }
      alpha = Math.max(alpha, best);
      if(beta <= alpha) break;
    }
    return {score: best, action: bestAction};
  }else{
    let best = Infinity;
    for(const act of actions){
      const next = applyAction(state, 'W', act);
      const res = minimax(next, depth-1, alpha, beta, true);
      if(res.score < best){ best = res.score; bestAction = act; }
      beta = Math.min(beta, best);
      if(beta <= alpha) break;
    }
    return {score: best, action: bestAction};
  }
}

function aiMove(){
  if(game.winner) return;
  if(game.turn!=='B') return;

  setStatus("AI düşünüyor...");
  setTimeout(()=>{
    const depth = phaseOf(game,'B')==="placing" ? 3 : 4;
    const {action} = minimax(game, depth, -Infinity, Infinity, true);
    if(!action){
      game.winner = checkWinner(game) || 'W';
      render();
      setStatus("AI hamle bulamadı. Kazanan: " + (game.winner==='W' ? "Sen" : "AI"));
      return;
    }

    game = applyAction(game, 'B', action);
    pushHistory();
    render();

    if(game.winner){
      setStatus("Oyun bitti. Kazanan: " + (game.winner==='W' ? "Sen" : "AI"));
    }else{
      setStatus(action.millMade ? "AI değirmen yaptı ve 1 taşını kaldırdı. Sıra sende." : "AI hamle yaptı. Sıra sende.");
    }
  }, 140);
}

/* ====== UI ====== */
function setStatus(text){ $("#status").textContent = text; }

function updateKPI(){
  $("#wOnBoard").textContent = countOnBoard(game.board,'W');
  $("#bOnBoard").textContent = countOnBoard(game.board,'B');
  $("#wPlaced").textContent = game.placed.W;
  $("#bPlaced").textContent = game.placed.B;

  const phase = (game.placed.W<9 || game.placed.B<9) ? "Taş koyma" : "Hareket";
  $("#phasePill").textContent = "Aşama: " + phase;
}

function render(){
  positionsG.innerHTML = "";
  for(let i=0;i<24;i++){
    const [x,y] = POS[i];
    const v = game.board[i];

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", x); c.setAttribute("cy", y);
    c.setAttribute("r", 26);
    c.classList.add("pos");
    if(v===null) c.classList.add("empty");
    if(game.pendingMover===i) c.classList.add("sel","glow");
    c.addEventListener("click", ()=> onClickPos(i));
    g.appendChild(c);

    if(v!==null){
      const s = document.createElementNS("http://www.w3.org/2000/svg","circle");
      s.setAttribute("cx", x); s.setAttribute("cy", y);
      s.setAttribute("r", 18);
      s.classList.add(v==='W' ? "stoneW" : "stoneB");
      s.classList.add("glow");
      g.appendChild(s);
    }

    positionsG.appendChild(g);
  }

  updateKPI();
  $("#hintBtn").disabled = !!game.winner || game.turn!=='W';
}

function humanAction(action){
  game = applyAction(game, 'W', action);
  pushHistory();
  render();
  if(game.winner){
    setStatus("Oyun bitti. Kazanan: " + (game.winner==='W' ? "Sen" : "AI"));
    return;
  }
  aiMove();
}

function onClickPos(i){
  if(game.winner) return;
  if(game.turn!=='W') return;

  const b = game.board;
  const phase = phaseOf(game,'W');
  const opp = 'B';

  // TAŞ KOYMA
  if(phase==="placing"){
    if(game.captureMode && game._temp){
      const {removable} = game._temp;
      if(b[i]!==opp) return;
      if(!removable.includes(i)) return;
      const action = {...game._temp, capture:i};
      game.captureMode = false; game._temp=null;
      humanAction(action);
      return;
    }

    if(b[i]!==null) return;

    const b2 = b.slice(); b2[i]='W';
    const millMade = millsFormedBy(b2,'W',i).length>0;

    if(!millMade){
      humanAction({type:'place', from:null, to:i, millMade:false, capture:null});
      return;
    }

    const removable = removableOpponentStones(b2, opp);
    setStatus("Değirmen yaptın! Şimdi rakibin bir taşına dokun (mümkünse değirmende olmayan).");
    game.captureMode = true;
    game._temp = {type:'place', from:null, to:i, millMade:true, removable};
    render();
    return;
  }

  // HAREKET/UÇMA - TAŞ ALMA MODU
  if(game.captureMode && game._temp){
    const {removable} = game._temp;
    if(b[i]!==opp) return;
    if(!removable.includes(i)) return;
    const action = {...game._temp, capture:i};
    game.captureMode = false; game._temp=null;
    humanAction(action);
    return;
  }

  // TAŞ SEÇ
  if(b[i]==='W'){
    game.pendingMover = (game.pendingMover===i ? null : i);
    render();
    if(game.pendingMover!==null){
      const fly = canFly(game,'W');
      setStatus(fly ? "Taş seçildi. Uçma var: herhangi bir boş noktaya dokun." : "Taş seçildi. Komşu boş noktaya dokun.");
    }else{
      setStatus("Sıra sende.");
    }
    return;
  }

  // HEDEFE OYNA
  if(b[i]===null && game.pendingMover!==null){
    const from = game.pendingMover;
    const fly = canFly(game,'W');
    if(!fly && !ADJ[from].includes(i)) return;

    const b2 = b.slice();
    b2[from]=null; b2[i]='W';
    const millMade = millsFormedBy(b2,'W',i).length>0;

    if(!millMade){
      game.pendingMover = null;
      humanAction({type:'move', from, to:i, millMade:false, capture:null});
      return;
    }

    const removable = removableOpponentStones(b2, opp);
    setStatus("Değirmen yaptın! Şimdi rakibin bir taşına dokun.");
    game.captureMode = true;
    game._temp = {type:'move', from, to:i, millMade:true, removable};
    game.pendingMover = null;
    render();
    return;
  }
}

function hint(){
  if(game.turn!=='W' || game.winner) return;
  const depth = phaseOf(game,'W')==="placing" ? 3 : 4;
  const {action} = minimax(game, depth, -Infinity, Infinity, false);
  if(!action){ setStatus("İpucu bulunamadı."); return; }
  const label = (i)=> `#${i+1}`;
  const msg =
    action.type==='place'
      ? `İpucu: ${label(action.to)} noktasına taş koy.`
      : `İpucu: ${label(action.from)} → ${label(action.to)}.`;
  setStatus(msg);
}

/* ====== Butonlar ====== */
$("#newBtn").addEventListener("click", newGame);
$("#undoBtn").addEventListener("click", undo);
$("#hintBtn").addEventListener("click", hint);

/* ====== Giriş (kayıt) akışı ====== */
$("#startBtn").addEventListener("click", async ()=>{
  const name = $("#name").value.trim();
  const classroom = $("#classroom").value.trim();
  if(!name || !classroom){
    setLoginMsg("Ad Soyad ve Sınıf/Şube zorunlu.");
    return;
  }

  $("#startBtn").disabled = true;
  setLoginMsg("Kaydediliyor...");

  try{
    await addDoc(collection(db,"sessions"),{
      name,
      classroom,
      createdAt: serverTimestamp(),
      userAgent: navigator.userAgent
    });

    // kayıt tamam → oyun
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("gameUI").style.display = "flex";
    newGame();

  }catch(e){
    console.error(e);
    setLoginMsg("Kayıt hatası. İnternet/Firebase kontrol edin.");
    $("#startBtn").disabled = false;
  }
});
</script>
</body>
</html>
