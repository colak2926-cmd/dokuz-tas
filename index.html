<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokuz TaÅŸ â€“ GerÃ§ek Kurallar (AI + Online)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --line:#93a4ff55; --text:#e9edff; --muted:#b9c2ff;
      --btn:#0f1630; --btnb:#2a3570; --accent:#7aa2ff;
      --orange:#f59e0b; --orange2:#ffd08a;
      --navy:#0b3a8a; --navy2:#7aa2ff;
      --danger:#ff6b6b; --ok:#6ee7b7;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; display:flex; flex-direction:column; gap:12px; }
    .card{ background:var(--panel); border:1px solid var(--btnb); border-radius:16px; padding:14px; }
    h1{ margin:0 0 8px 0; font-size:18px; font-weight:900; }
    .small{ font-size:12px; color:var(--muted); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .grid2{ display:grid; grid-template-columns: 1.4fr 1fr; gap:12px; align-items:stretch; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }
    button{
      border:1px solid var(--btnb); background:var(--btn); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800;
    }
    button:hover{ border-color:#4052b6; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    input, select{
      width:100%; border:1px solid var(--btnb); background:var(--btn); color:var(--text);
      padding:12px; border-radius:12px;
    }
    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:var(--btn); border:1px solid var(--btnb); color:var(--muted); font-size:12px;
    }
    .status{ min-height:44px; padding-top:8px; line-height:1.35; color:var(--muted); }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .kpi > div{ background:var(--btn); border:1px solid var(--btnb); border-radius:12px; padding:10px; font-size:13px; color:var(--muted); }
    .kpi b{ color:var(--text); }
    .divider{ height:1px; background:#24306a; margin:12px 0; }
    svg{ width:100%; height:auto; max-width:650px; }
    .line{ stroke:var(--line); stroke-width:8; stroke-linecap:round; }

    /* NOKTALAR (tÄ±klama alanÄ± bÃ¼yÃ¼k + gÃ¶rÃ¼nÃ¼r) */
    .pos{
      fill:#0b1020;
      stroke:#93a4ffcc;
      stroke-width:5;
      opacity:.98;
    }
    .pos.empty{ cursor:pointer; }
    .pos.empty:hover{ stroke:#c7d2fe; }
    .sel{ stroke:#ffd166 !important; stroke-width:6 !important; }

    /* TAÅžLAR */
    .stoneW{ fill:var(--orange); stroke:var(--orange2); stroke-width:3; }
    .stoneB{ fill:var(--navy); stroke:var(--navy2); stroke-width:3; }
    .stoneW, .stoneB{ pointer-events:none; }

    /* OYUN BÄ°TTÄ° MODAL + KONFETÄ° */
    #overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); z-index:50;
      padding:18px;
    }
    #modal{
      width:min(520px, 92vw);
      background:linear-gradient(180deg,#16204a,#0f1630);
      border:1px solid #4052b6; border-radius:18px; padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      text-align:center;
    }
    #modal h2{ margin:0 0 8px 0; font-size:28px; }
    #modal p{ margin:0 0 14px 0; color:var(--muted); }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .primary{ border-color:#4052b6; }
    .ok{ color:#052016; background:var(--ok); border-color:rgba(255,255,255,.25); }
    .bad{ color:#2b0b0b; background:var(--danger); border-color:rgba(255,255,255,.25); }
    #confetti{
      position:fixed; inset:0; pointer-events:none; z-index:60; display:none;
    }
    .rightBox{ display:flex; flex-direction:column; gap:10px; }
    .mutedBox{ background:var(--btn); border:1px solid var(--btnb); border-radius:12px; padding:10px; }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div id="overlay">
    <div id="modal">
      <h2 id="endTitle">Oyun bitti</h2>
      <p id="endText">â€”</p>
      <div class="btnRow">
        <button class="ok" id="playAgainBtn">Tekrar Dene</button>
        <button class="primary" id="closeEndBtn">Kapat</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- GÄ°RÄ°Åž -->
    <div class="card" id="loginCard">
      <h1>Dokuz TaÅŸ â€“ GiriÅŸ</h1>
      <div class="small">AI veya Online Rakip seÃ§ebilirsin. Onlineâ€™da Host=Turuncu, Guest=Lacivert.</div>
      <div style="height:10px"></div>

      <div class="row">
        <div style="flex:1 1 260px">
          <div class="small">Ad Soyad</div>
          <input id="name" placeholder="Ã–rn: AyÅŸe YÄ±lmaz" autocomplete="name">
        </div>
        <div style="flex:0.7 1 160px">
          <div class="small">SÄ±nÄ±f/Åžube</div>
          <input id="classroom" placeholder="Ã–rn: 5/A">
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button id="aiBtn">Bilgisayara KarÅŸÄ± (AI)</button>
        <button id="onlineBtn">Online Rakip</button>
      </div>

      <div class="divider"></div>

      <div id="onlineBox" style="display:none" class="mutedBox">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1 1 220px">
            <div class="small">Oda Kodu (varsa)</div>
            <input id="roomCode" placeholder="Ã–rn: QDW5U2">
          </div>
          <button id="createRoomBtn">Oda OluÅŸtur</button>
          <button id="joinRoomBtn">Odaya Gir</button>
        </div>
        <div class="small" style="margin-top:8px">
          Not: OdayÄ± oluÅŸturan kiÅŸi <b>Turuncu</b>, odaya giren kiÅŸi <b>Lacivert</b> olur.
        </div>
      </div>

      <div class="status" id="loginMsg"></div>
    </div>

    <!-- OYUN -->
    <div class="grid2" id="gameUI" style="display:none">
      <div class="card" style="display:flex; align-items:center; justify-content:center;">
        <svg viewBox="0 0 1000 1000" aria-label="Dokuz taÅŸ tahtasÄ±">
          <rect x="100" y="100" width="800" height="800" fill="none" class="line"/>
          <rect x="250" y="250" width="500" height="500" fill="none" class="line"/>
          <rect x="400" y="400" width="200" height="200" fill="none" class="line"/>

          <line x1="500" y1="100" x2="500" y2="400" class="line"/>
          <line x1="500" y1="600" x2="500" y2="900" class="line"/>
          <line x1="100" y1="500" x2="400" y2="500" class="line"/>
          <line x1="600" y1="500" x2="900" y2="500" class="line"/>

          <g id="positions"></g>
        </svg>
      </div>

      <div class="card rightBox">
        <div>
          <h1>Dokuz TaÅŸ â€“ GerÃ§ek Kurallar</h1>
          <div class="row">
            <span class="pill" id="pOrange">Turuncu: Host / Sen</span>
            <span class="pill" id="pNavy">Lacivert: Guest / Rakip</span>
            <span class="pill" id="modePill">Mod: â€”</span>
            <span class="pill" id="phasePill">AÅŸama: â€”</span>
          </div>

          <div class="kpi">
            <div>Turuncu: Tahtada <b id="wOnBoard">0</b> / YerleÅŸen <b id="wPlaced">0</b></div>
            <div>Lacivert: Tahtada <b id="bOnBoard">0</b> / YerleÅŸen <b id="bPlaced">0</b></div>
          </div>

          <div class="status" id="status"></div>

          <div class="row">
            <button id="newBtn">Yeni Oyun</button>
            <button id="undoBtn">Geri Al</button>
            <button id="hintBtn">Ä°pucu</button>
          </div>

          <div class="divider"></div>

          <div class="small">
            <b>KÄ±sa kullanÄ±m:</b>
            <ul style="margin:6px 0 0 18px; padding:0;">
              <li><b>TaÅŸ koyma:</b> boÅŸ noktaya dokun.</li>
              <li><b>Hareket:</b> kendi taÅŸÄ±na dokun â†’ komÅŸu boÅŸ noktaya dokun.</li>
              <li><b>UÃ§ma:</b> 3 taÅŸ kalÄ±nca istediÄŸin boÅŸ noktaya gidebilirsin.</li>
              <li><b>DeÄŸirmen:</b> 3â€™lÃ¼ yapÄ±nca rakipten 1 taÅŸ kaldÄ±rÄ±rsÄ±n (mÃ¼mkÃ¼nse deÄŸirmende olmayan).</li>
            </ul>
          </div>

          <div class="divider"></div>

          <div class="row">
            <span class="small"><b>Oda:</b> <span id="roomLabel">â€”</span></span>
            <span class="pill" id="onlineState">â€”</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  /***********************
   * Firebase (Firestore)
   ***********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // âœ… Sende olan config
  const firebaseConfig = {
    apiKey: "AIzaSyAYzorBVSTCcE3xzDZ9PyPprBdYEzKov3c",
    authDomain: "oyun-3bfba.firebaseapp.com",
    projectId: "oyun-3bfba",
    storageBucket: "oyun-3bfba.firebasestorage.app",
    messagingSenderId: "120738565998",
    appId: "1:120738565998:web:81876d89cafa64a1207b7f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /***********************
   * Helpers
   ***********************/
  const $ = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const setLoginMsg = t => $("#loginMsg").textContent = t;
  const setStatus = t => $("#status").textContent = t;

  function randInt(n){
    if (window.crypto && crypto.getRandomValues) {
      const a = new Uint32Array(1);
      crypto.getRandomValues(a);
      return a[0] % n;
    }
    return Math.floor(Math.random()*n);
  }
  function pickRandom(arr){ return arr[arr.length ? randInt(arr.length) : 0]; }

  function makeRoomCode(len=6){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s="";
    for(let i=0;i<len;i++) s+=chars[randInt(chars.length)];
    return s;
  }

  /***********************
   * Board data
   ***********************/
  const POS = [
    [100,100],[500,100],[900,100],
    [250,250],[500,250],[750,250],
    [400,400],[500,400],[600,400],
    [100,500],[250,500],[400,500],[600,500],[750,500],[900,500],
    [400,600],[500,600],[600,600],
    [250,750],[500,750],[750,750],
    [100,900],[500,900],[900,900]
  ];

  const ADJ = [
    [1,9],[0,2,4],[1,14],[4,10],[1,3,5,7],[4,13],[7,11],[4,6,8],[7,12],
    [0,10,21],[3,9,11,18],[6,10,15],[8,13,17],[5,12,14,20],[2,13,23],
    [11,16],[15,17,19],[12,16],[10,19],[16,18,20,22],[13,19],[9,22],[19,21,23],[14,22]
  ];

  const MILLS = [
    [0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,13,14],[15,16,17],[18,19,20],[21,22,23],
    [0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],[5,13,20],[2,14,23]
  ];

  const positionsG = document.getElementById("positions");

  /***********************
   * Game state
   ***********************/
  const EMPTY = null;
  let game = null;
  let history = [];

  // Mode / Online
  let mode = "AI"; // "AI" or "ONLINE"
  let roomId = null;
  let role = "HOST"; // HOST or GUEST (online)
  let unsubRoom = null;

  // Human colors by role in online:
  // HOST = W (Turuncu), GUEST = B (Lacivert)
  function myPlayer(){
    if(mode==="AI") return 'W';               // AI mod: kullanÄ±cÄ± her zaman Turuncu
    return role==="HOST" ? 'W' : 'B';
  }

  function oppPlayer(){
    return myPlayer()==='W' ? 'B' : 'W';
  }

  function newGameState(){
    return {
      board: Array(24).fill(EMPTY),
      turn: 'W',
      placed: {W:0, B:0},
      captureMode: false,
      pendingMover: null,
      winner: null,
      _temp: null,
      lastMove: null
    };
  }

  function pushHistory(){
    history.push(JSON.parse(JSON.stringify(game)));
    $("#undoBtn").disabled = history.length<=1 || mode==="ONLINE"; // online'da geri al yok
  }

  function countOnBoard(board, p){ return board.filter(x=>x===p).length; }
  function phaseOf(state, p){ return state.placed[p] < 9 ? "placing" : "moving"; }
  function canFly(state, p){ return phaseOf(state,p)==="moving" && countOnBoard(state.board,p) <= 3; }

  function millsFormedBy(board, p, posIndex){
    return MILLS.filter(m => m.includes(posIndex) && m.every(i => board[i]===p));
  }
  function isInAnyMill(board, p, idx){
    return MILLS.some(m => m.includes(idx) && m.every(i => board[i]===p));
  }
  function removableOpponentStones(board, opponent){
    const oppIdx = board.map((v,i)=> v===opponent ? i : -1).filter(i=>i>=0);
    const notInMill = oppIdx.filter(i => !isInAnyMill(board, opponent, i));
    return notInMill.length ? notInMill : oppIdx;
  }

  function hasAnyLegalMove(state, p){
    const b = state.board;
    if(phaseOf(state,p)==="placing") return b.some(x=>x===EMPTY);

    const fly = canFly(state,p);
    const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);

    if(fly) return b.some(x=>x===EMPTY) && my.length>0;

    for(const from of my){
      if(ADJ[from].some(to => b[to]===EMPTY)) return true;
    }
    return false;
  }

  // âœ… Kazanma kontrolÃ¼: yerleÅŸtirme bittikten sonra
  function checkWinner(state){
    if (state.placed.W < 9 || state.placed.B < 9) return null;

    const wCount = countOnBoard(state.board,'W');
    const bCount = countOnBoard(state.board,'B');

    if (wCount < 3 || !hasAnyLegalMove(state,'W')) return 'B';
    if (bCount < 3 || !hasAnyLegalMove(state,'B')) return 'W';
    return null;
  }

  function applyAction(state, p, action){
    const opp = p==='W' ? 'B' : 'W';
    const s = JSON.parse(JSON.stringify(state));
    const b = s.board;

    // anti "aynÄ± hamle" (Ã¼st Ã¼ste aynÄ± hareketi tekrarlatma) - basit
    if(s.lastMove && action.type==='move'){
      const lm = s.lastMove;
      if(lm.p===p && lm.type==='move' && lm.from===action.from && lm.to===action.to){
        // aynÄ± hamleyi tekrar yapma
        return null;
      }
    }

    if(action.type==='place'){
      if(b[action.to]!==EMPTY) return null;
      b[action.to]=p;
      s.placed[p]+=1;
    }else{
      if(b[action.from]!==p) return null;
      if(b[action.to]!==EMPTY) return null;
      b[action.from]=EMPTY;
      b[action.to]=p;
    }

    if(action.capture!==null && action.capture!==undefined){
      if(b[action.capture]===opp) b[action.capture]=EMPTY;
      else return null;
    }

    s.turn = opp;
    s.pendingMover = null;
    s.captureMode = false;
    s._temp = null;
    s.lastMove = { p, type: action.type, from: action.from ?? null, to: action.to ?? null, capture: action.capture ?? null };

    s.winner = checkWinner(s);
    return s;
  }

  /***********************
   * AI (minimax)
   ***********************/
  function generateActions(state, p){
    const opp = p==='W' ? 'B' : 'W';
    const actions = [];
    const board = state.board;
    const phase = phaseOf(state,p);

    const addCaptureVariants = (boardAfter, moveObj) => {
      if(!moveObj.millMade){
        actions.push({...moveObj, capture: null});
        return;
      }
      const removable = removableOpponentStones(boardAfter, opp);
      for(const cap of removable){
        actions.push({...moveObj, capture: cap});
      }
    };

    if(phase==="placing"){
      for(let to=0; to<24; to++){
        if(board[to]!==EMPTY) continue;
        const b2 = board.slice();
        b2[to]=p;
        const millMade = millsFormedBy(b2,p,to).length>0;
        addCaptureVariants(b2, {type:'place', from:null, to, millMade});
      }
      return actions;
    }

    const fly = canFly(state,p);
    const my = board.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);

    for(const from of my){
      const targets = fly
        ? board.map((v,i)=> v===EMPTY ? i : -1).filter(i=>i>=0)
        : ADJ[from].filter(to => board[to]===EMPTY);

      for(const to of targets){
        const b2 = board.slice();
        b2[from]=EMPTY; b2[to]=p;
        const millMade = millsFormedBy(b2,p,to).length>0;
        addCaptureVariants(b2, {type:'move', from, to, millMade});
      }
    }
    return actions;
  }

  function evalState(state){
    const b = state.board;
    const w = countOnBoard(b,'W');
    const bl = countOnBoard(b,'B');
    const material = (bl - w) * 100;

    const millsW = MILLS.filter(m => m.every(i => b[i]==='W')).length;
    const millsB = MILLS.filter(m => m.every(i => b[i]==='B')).length;
    const millsScore = (millsB - millsW) * 60;

    const pot = (p)=>{
      let c=0;
      for(const m of MILLS){
        const vals = m.map(i=>b[i]);
        const cntP = vals.filter(v=>v===p).length;
        const cntE = vals.filter(v=>v===EMPTY).length;
        if(cntP===2 && cntE===1) c++;
      }
      return c;
    };
    const potScore = (pot('B') - pot('W')) * 18;

    const mob = (p)=>{
      const ph = phaseOf(state,p);
      if(ph==="placing") return 0;
      const fly = canFly(state,p);
      if(fly) return b.filter(v=>v===EMPTY).length;
      let moves=0;
      for(let i=0;i<24;i++){
        if(b[i]!==p) continue;
        moves += ADJ[i].filter(j=>b[j]===EMPTY).length;
      }
      return moves;
    };
    const mobScore = (mob('B') - mob('W')) * 4;

    if(state.winner==='B') return 1e9;
    if(state.winner==='W') return -1e9;

    return material + millsScore + potScore + mobScore;
  }

  function minimax(state, depth, alpha, beta, maximizingForB){
    if(depth===0 || state.winner) return {score: evalState(state), action: null};

    const p = maximizingForB ? 'B' : 'W';
    const actions = generateActions(state, p);
    if(!actions.length) return {score: evalState(state), action: null};

    // hamle sÄ±ralama
    actions.sort((a,b)=>{
      const sa = (a.millMade?50:0) + (a.capture!=null?30:0);
      const sb = (b.millMade?50:0) + (b.capture!=null?30:0);
      return sb-sa;
    });

    let bestAction = null;

    if(maximizingForB){
      let best = -Infinity;
      for(const act of actions){
        const next = applyAction(state, 'B', act);
        if(!next) continue;
        const res = minimax(next, depth-1, alpha, beta, false);
        if(res.score > best){ best = res.score; bestAction = act; }
        alpha = Math.max(alpha, best);
        if(beta <= alpha) break;
      }
      return {score: best, action: bestAction};
    }else{
      let best = Infinity;
      for(const act of actions){
        const next = applyAction(state, 'W', act);
        if(!next) continue;
        const res = minimax(next, depth-1, alpha, beta, true);
        if(res.score < best){ best = res.score; bestAction = act; }
        beta = Math.min(beta, best);
        if(beta <= alpha) break;
      }
      return {score: best, action: bestAction};
    }
  }

  // AI her oyunda farklÄ± baÅŸlasÄ±n: placing aÅŸamasÄ±nda top hamlelerden rastgele seÃ§
  function aiPickAction(){
    const phase = phaseOf(game,'B');
    if(phase==="placing"){
      const actions = generateActions(game,'B');
      const scored = actions.map(a=>{
        const s2 = applyAction(game,'B',a);
        return {a, score: s2 ? evalState(s2) : -1e15};
      }).sort((x,y)=> y.score - x.score);

      const top = scored.slice(0, Math.min(6, scored.length)).map(x=>x.a);
      return pickRandom(top);
    }

    const {action} = minimax(game, 4, -Infinity, Infinity, true);
    return action;
  }

  async function aiMove(){
    if(mode!=="AI") return;
    if(game.winner) return;
    if(game.turn!=='B') return;

    setStatus("AI dÃ¼ÅŸÃ¼nÃ¼yor...");
    await sleep(160);

    const action = aiPickAction();
    if(!action){
      game.winner = checkWinner(game) || 'W';
      render();
      endGameUI();
      return;
    }

    const next = applyAction(game,'B',action);
    if(!next){
      // nadiren olabilir; alternatif seÃ§
      const alts = generateActions(game,'B');
      let done=false;
      for(const a of alts){
        const n2 = applyAction(game,'B',a);
        if(n2){ game=n2; done=true; break; }
      }
      if(!done){
        game.winner = checkWinner(game) || 'W';
        render();
        endGameUI();
        return;
      }
    }else{
      game = next;
    }

    pushHistory();
    render();

    if(game.winner){
      endGameUI();
    }else{
      setStatus(action.millMade ? "AI deÄŸirmen yaptÄ±. SÄ±ra sende." : "AI hamle yaptÄ±. SÄ±ra sende.");
    }
  }

  /***********************
   * UI render
   ***********************/
  function updateKPI(){
    $("#wOnBoard").textContent = countOnBoard(game.board,'W');
    $("#bOnBoard").textContent = countOnBoard(game.board,'B');
    $("#wPlaced").textContent = game.placed.W;
    $("#bPlaced").textContent = game.placed.B;

    const phase = (game.placed.W<9 || game.placed.B<9) ? "TaÅŸ koyma" : "Hareket";
    $("#phasePill").textContent = "AÅŸama: " + phase;

    $("#hintBtn").disabled = !!game.winner || game.turn!==myPlayer() || mode==="ONLINE"; // online'da ipucu kapalÄ±
    $("#undoBtn").disabled = history.length<=1 || mode==="ONLINE" || !!game.winner;
  }

  function render(){
    positionsG.innerHTML = "";
    for(let i=0;i<24;i++){
      const [x,y] = POS[i];
      const v = game.board[i];

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");

      // click target (bÃ¼yÃ¼k)
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", x);
      c.setAttribute("cy", y);
      c.setAttribute("r", 38);                 // âœ… tÄ±klama alanÄ± bÃ¼yÃ¼k
      c.classList.add("pos");
      if(v===EMPTY) c.classList.add("empty");
      if(game.pendingMover===i) c.classList.add("sel");
      c.addEventListener("click", ()=> onClickPos(i));
      g.appendChild(c);

      // visible stone
      if(v!==EMPTY){
        const s = document.createElementNS("http://www.w3.org/2000/svg","circle");
        s.setAttribute("cx", x);
        s.setAttribute("cy", y);
        s.setAttribute("r", 18);
        s.classList.add(v==='W' ? "stoneW" : "stoneB");
        g.appendChild(s);
      }

      positionsG.appendChild(g);
    }

    updateKPI();

    // online durum
    if(mode==="ONLINE"){
      $("#modePill").textContent = "Mod: Online";
    }else{
      $("#modePill").textContent = "Mod: AI";
    }
  }

  /***********************
   * Human actions (AI + Online)
   ***********************/
  async function commitLocal(newState, statusText){
    game = newState;
    pushHistory();
    render();

    if(game.winner){
      endGameUI();
      return;
    }
    if(statusText) setStatus(statusText);

    if(mode==="AI"){
      await aiMove();
    }
  }

  async function commitOnline(newState){
    // onlineâ€™da stateâ€™i odaya yaz
    const r = doc(db, "rooms", roomId);
    await updateDoc(r, {
      game: newState,
      updatedAt: serverTimestamp()
    });
  }

  async function onClickPos(i){
    if(!game || game.winner) return;

    const me = myPlayer();
    const opp = me==='W' ? 'B' : 'W';

    // onlineâ€™da sÄ±ra kontrol
    if(game.turn !== me){
      setStatus("SÄ±ra sende deÄŸil.");
      return;
    }

    const b = game.board;
    const phase = phaseOf(game, me);

    // TAÅž ALMA MODU
    if(game.captureMode && game._temp){
      const {removable} = game._temp;
      if(b[i]!==opp) return;
      if(!removable.includes(i)) return;
      const action = {...game._temp, capture:i};

      const next = applyAction(game, me, action);
      if(!next) return;

      if(mode==="ONLINE"){
        await commitOnline(next);
      }else{
        await commitLocal(next, "TaÅŸ aldÄ±n. Rakip sÄ±rasÄ±.");
      }
      return;
    }

    // TAÅž KOYMA
    if(phase==="placing"){
      if(b[i]!==EMPTY) return;

      const b2 = b.slice();
      b2[i]=me;
      const millMade = millsFormedBy(b2, me, i).length>0;

      if(!millMade){
        const next = applyAction(game, me, {type:'place', from:null, to:i, millMade:false, capture:null});
        if(!next) return;

        if(mode==="ONLINE"){
          await commitOnline(next);
        }else{
          await commitLocal(next, "Hamle yapÄ±ldÄ±. Rakip sÄ±rasÄ±.");
        }
        return;
      }

      const removable = removableOpponentStones(b2, opp);
      setStatus("DeÄŸirmen yaptÄ±n! Rakibin bir taÅŸÄ±na dokun (mÃ¼mkÃ¼nse deÄŸirmende olmayan).");
      game.captureMode = true;
      game._temp = {type:'place', from:null, to:i, millMade:true, removable};
      render();
      return;
    }

    // TAÅž SEÃ‡
    if(b[i]===me){
      game.pendingMover = (game.pendingMover===i ? null : i);
      render();
      if(game.pendingMover!==null){
        const fly = canFly(game, me);
        setStatus(fly ? "TaÅŸ seÃ§ildi. UÃ§ma var: herhangi bir boÅŸ noktaya dokun." : "TaÅŸ seÃ§ildi. KomÅŸu boÅŸ noktaya dokun.");
      }else{
        setStatus("SÄ±ra sende.");
      }
      return;
    }

    // HEDEF (HAREKET/UÃ‡MA)
    if(b[i]===EMPTY && game.pendingMover!==null){
      const from = game.pendingMover;
      const fly = canFly(game, me);
      if(!fly && !ADJ[from].includes(i)) return;

      const b2 = b.slice();
      b2[from]=EMPTY; b2[i]=me;
      const millMade = millsFormedBy(b2, me, i).length>0;

      if(!millMade){
        const next = applyAction(game, me, {type:'move', from, to:i, millMade:false, capture:null});
        if(!next) return;
        game.pendingMover=null;

        if(mode==="ONLINE"){
          await commitOnline(next);
        }else{
          await commitLocal(next, "Hamle yapÄ±ldÄ±. Rakip sÄ±rasÄ±.");
        }
        return;
      }

      const removable = removableOpponentStones(b2, opp);
      setStatus("DeÄŸirmen yaptÄ±n! Rakibin bir taÅŸÄ±na dokun.");
      game.captureMode = true;
      game._temp = {type:'move', from, to:i, millMade:true, removable};
      game.pendingMover = null;
      render();
      return;
    }
  }

  function hint(){
    if(mode!=="AI") return;
    if(game.turn!==myPlayer() || game.winner) return;
    const depth = phaseOf(game,myPlayer())==="placing" ? 3 : 4;
    const {action} = minimax(game, depth, -Infinity, Infinity, false);
    if(!action){ setStatus("Ä°pucu bulunamadÄ±."); return; }
    const msg = action.type==='place'
      ? `Ä°pucu: #${action.to+1} noktasÄ±na taÅŸ koy.`
      : `Ä°pucu: #${action.from+1} â†’ #${action.to+1}.`;
    setStatus(msg);
  }

  function undo(){
    if(mode==="ONLINE") return;
    if(history.length<=1) return;
    history.pop();
    game = JSON.parse(JSON.stringify(history[history.length-1]));
    render();
    setStatus("Geri alÄ±ndÄ±.");
  }

  /***********************
   * Online room sync
   ***********************/
  async function listenRoom(){
    if(unsubRoom) { unsubRoom(); unsubRoom=null; }
    const r = doc(db,"rooms",roomId);

    unsubRoom = onSnapshot(r, (snap)=>{
      if(!snap.exists()) return;
      const data = snap.data();

      // oyun state
      if(data.game){
        game = data.game;
        // history reset (online)
        history = [JSON.parse(JSON.stringify(game))];
        render();

        // mesajlar
        const me = myPlayer();
        if(game.winner){
          endGameUI();
          return;
        }
        if(game.turn===me){
          setStatus("SÄ±ra sende.");
        }else{
          setStatus("Rakip oynuyor...");
        }
      }

      // oyuncu durumu
      const host = data.host?.name ? "Host: " + data.host.name : "Host: â€”";
      const guest = data.guest?.name ? "Guest: " + data.guest.name : "Guest: bekleniyorâ€¦";
      $("#onlineState").textContent = (data.guest?.name ? "HazÄ±r" : "Rakip bekleniyorâ€¦");
      $("#roomLabel").textContent = roomId + " â€¢ " + host + " â€¢ " + guest;

      // etiketleri role'a gÃ¶re dÃ¼zelt
      if(role==="HOST"){
        $("#pOrange").textContent = "Turuncu: Host / Sen";
        $("#pNavy").textContent = "Lacivert: Guest / Rakip";
      }else{
        $("#pOrange").textContent = "Turuncu: Host / Rakip";
        $("#pNavy").textContent = "Lacivert: Guest / Sen";
      }
    });
  }

  async function createRoom(){
    const name = $("#name").value.trim();
    const classroom = $("#classroom").value.trim();
    if(!name || !classroom){
      setLoginMsg("Ad Soyad ve SÄ±nÄ±f/Åžube zorunlu.");
      return;
    }

    roomId = makeRoomCode();
    role = "HOST";
    mode = "ONLINE";

    // kayÄ±t dÃ¼ÅŸsÃ¼n (kim girdi)
    await addDoc(collection(db,"sessions"),{
      name, classroom, mode:"ONLINE_CREATE", roomId,
      createdAt: serverTimestamp(), userAgent: navigator.userAgent
    });

    // oda dokÃ¼manÄ±
    const r = doc(db,"rooms",roomId);
    const initialGame = newGameState();
    await setDoc(r, {
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      host: { name, classroom, joinedAt: serverTimestamp() },
      guest: null,
      game: initialGame
    });

    openGameUI();
    await listenRoom();
    setStatus("Oda oluÅŸturuldu. Rakip oda koduyla girsin: " + roomId);
  }

  async function joinRoom(){
    const name = $("#name").value.trim();
    const classroom = $("#classroom").value.trim();
    const code = $("#roomCode").value.trim().toUpperCase();

    if(!name || !classroom){
      setLoginMsg("Ad Soyad ve SÄ±nÄ±f/Åžube zorunlu.");
      return;
    }
    if(!code){
      setLoginMsg("Oda kodu gir.");
      return;
    }

    roomId = code;
    role = "GUEST";
    mode = "ONLINE";

    const r = doc(db,"rooms",roomId);
    const snap = await getDoc(r);
    if(!snap.exists()){
      setLoginMsg("Bu oda bulunamadÄ±: " + roomId);
      return;
    }

    // kayÄ±t dÃ¼ÅŸsÃ¼n
    await addDoc(collection(db,"sessions"),{
      name, classroom, mode:"ONLINE_JOIN", roomId,
      createdAt: serverTimestamp(), userAgent: navigator.userAgent
    });

    // guest yaz
    await updateDoc(r, {
      guest: { name, classroom, joinedAt: serverTimestamp() },
      updatedAt: serverTimestamp()
    });

    openGameUI();
    await listenRoom();
    setStatus("Odaya girdin. Oyun baÅŸlÄ±yor.");
  }

  /***********************
   * Start / New game
   ***********************/
  function openGameUI(){
    $("#loginCard").style.display="none";
    $("#gameUI").style.display="grid";

    $("#roomLabel").textContent = (mode==="ONLINE" ? roomId : "â€”");
    $("#onlineState").textContent = (mode==="ONLINE" ? "BaÄŸlanÄ±yor..." : "â€”");
    $("#modePill").textContent = "Mod: " + (mode==="ONLINE" ? "Online" : "AI");
  }

  async function startAI(){
    const name = $("#name").value.trim();
    const classroom = $("#classroom").value.trim();
    if(!name || !classroom){
      setLoginMsg("Ad Soyad ve SÄ±nÄ±f/Åžube zorunlu.");
      return;
    }

    mode="AI";
    role="HOST";
    roomId=null;

    // giriÅŸ kaydÄ±
    await addDoc(collection(db,"sessions"),{
      name, classroom, mode:"AI",
      createdAt: serverTimestamp(), userAgent: navigator.userAgent
    });

    openGameUI();
    game = newGameState();
    history=[];
    pushHistory();
    render();
    setStatus("SÄ±ra sende. BoÅŸ bir noktaya taÅŸ koy.");
  }

  async function newGame(){
    if(mode==="AI"){
      game = newGameState();
      history=[];
      pushHistory();
      render();
      setStatus("Yeni oyun. SÄ±ra sende.");
      return;
    }

    // ONLINE: sadece HOST yeni oyun baÅŸlatabilir (dilersen kaldÄ±rabilirsin)
    if(role!=="HOST"){
      setStatus("Onlineâ€™da yeni oyunu Host baÅŸlatÄ±r.");
      return;
    }

    const r = doc(db,"rooms",roomId);
    const fresh = newGameState();
    await updateDoc(r, { game: fresh, updatedAt: serverTimestamp() });
    setStatus("Yeni oyun baÅŸlatÄ±ldÄ±.");
  }

  /***********************
   * End game UI + confetti
   ***********************/
  function showOverlay(title, text, win){
    $("#endTitle").textContent = title;
    $("#endText").textContent = text;
    $("#overlay").style.display="flex";
    if(win) startConfetti();
  }
  function hideOverlay(){
    $("#overlay").style.display="none";
    stopConfetti();
  }

  function endGameUI(){
    if(!game || !game.winner) return;

    const me = myPlayer();
    const win = (game.winner === me);

    if(win){
      showOverlay("KAZANDIN!", "Tebrikler ðŸŽ‰ Yeni oyun iÃ§in â€œTekrar Deneâ€ye bas.", true);
    }else{
      showOverlay("KAYBETTÄ°N", "Tekrar dene ve stratejini deÄŸiÅŸtir. â€œTekrar Deneâ€ye bas.", false);
    }
    render();
  }

  // Simple confetti
  const conf = $("#confetti");
  const ctx = conf.getContext("2d");
  let confOn = false;
  let pieces = [];

  function resizeConf(){
    conf.width = window.innerWidth * devicePixelRatio;
    conf.height = window.innerHeight * devicePixelRatio;
    conf.style.width = window.innerWidth + "px";
    conf.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeConf);

  function startConfetti(){
    resizeConf();
    conf.style.display="block";
    confOn = true;
    pieces = Array.from({length:180}).map(()=>({
      x: Math.random()*window.innerWidth,
      y: -20 - Math.random()*window.innerHeight*0.4,
      r: 3 + Math.random()*5,
      vx: -1.2 + Math.random()*2.4,
      vy: 2 + Math.random()*4.5,
      rot: Math.random()*Math.PI,
      vr: -0.15 + Math.random()*0.3,
      hue: Math.random()*360
    }));
    tickConfetti();
  }
  function stopConfetti(){
    confOn = false;
    conf.style.display="none";
  }
  function tickConfetti(){
    if(!confOn) return;
    ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

    for(const p of pieces){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.02; // gravity

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${p.hue} 85% 60%)`;
      ctx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.2);
      ctx.restore();

      if(p.y > window.innerHeight + 40){
        p.y = -20;
        p.x = Math.random()*window.innerWidth;
        p.vy = 2 + Math.random()*4.5;
      }
    }
    requestAnimationFrame(tickConfetti);
  }

  /***********************
   * Buttons wiring
   ***********************/
  $("#aiBtn").addEventListener("click", startAI);

  $("#onlineBtn").addEventListener("click", ()=>{
    const box = $("#onlineBox");
    box.style.display = (box.style.display==="none" ? "block" : "none");
    setLoginMsg("");
  });

  $("#createRoomBtn").addEventListener("click", createRoom);
  $("#joinRoomBtn").addEventListener("click", joinRoom);

  $("#newBtn").addEventListener("click", newGame);
  $("#undoBtn").addEventListener("click", undo);
  $("#hintBtn").addEventListener("click", hint);

  $("#playAgainBtn").addEventListener("click", async ()=>{
    hideOverlay();
    await newGame();
  });
  $("#closeEndBtn").addEventListener("click", hideOverlay);

  // Ä°lk aÃ§Ä±lÄ±ÅŸ
  $("#onlineBox").style.display="none";
  setLoginMsg("");
</script>
</body>
</html>
