  <!doctype html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DÃœZCE Ä°SABET OKULLARI DOKUZ TAÅ OYUNU</title>

  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --text:#e9edff; --muted:#b9c2ff;
      --btn:#0f1630; --btnb:#2a3570;

      --orange:#f59e0b; --orange2:#ffd08a;
      --navy:#0b3a8a;   --navy2:#7aa2ff;

      --lineO: rgba(245, 158, 11, .55);
      --lineN: rgba(122, 162, 255, .55);

      --posFill:#0b1020;
      --posStroke:#93a4ffcc;

      --modal1:#16204a; --modal2:#0f1630;
      --divider:#24306a;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#0b1020;
      --muted:#334155;
      --btn:#f1f5f9;
      --btnb:#cbd5e1;

      --posFill:#f6f7fb;
      --posStroke:#3b82f6aa;

      --modal1:#ffffff;
      --modal2:#f1f5f9;
      --divider:#e2e8f0;

      --lineO: rgba(245, 158, 11, .65);
      --lineN: rgba(11, 58, 138, .45);
    }

    *{box-sizing:border-box}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; display:flex; flex-direction:column; gap:12px; }

    .card{ background:var(--panel); border:1px solid var(--btnb); border-radius:16px; padding:14px; }
    h1{ margin:0 0 8px 0; font-size:18px; font-weight:950; }
    .small{ font-size:12px; color:var(--muted); }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .grid2{ display:grid; grid-template-columns: 1.35fr 1fr; gap:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }

    button{
      border:1px solid var(--btnb); background:var(--btn); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:850;
    }
    button:hover{ border-color:#4052b6; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    input{
      width:100%; border:1px solid var(--btnb); background:var(--btn); color:var(--text);
      padding:12px; border-radius:12px;
    }
    select{
      padding:10px 12px; border-radius:12px; border:1px solid var(--btnb);
      background:var(--btn); color:var(--text); font-weight:850;
    }

    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:var(--btn); border:1px solid var(--btnb); color:var(--muted); font-size:12px;
    }
    .status{ min-height:44px; padding-top:8px; line-height:1.35; color:var(--muted); }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .kpi > div{ background:var(--btn); border:1px solid var(--btnb); border-radius:12px; padding:10px; font-size:13px; color:var(--muted); }
    .kpi b{ color:var(--text); }
    .divider{ height:1px; background:var(--divider); margin:12px 0; }

    svg{ width:100%; height:auto; max-width:650px; }
    .lineO{ stroke:var(--lineO); stroke-width:10; stroke-linecap:round; }
    .lineN{ stroke:var(--lineN); stroke-width:10; stroke-linecap:round; }

    .pos{ fill:var(--posFill); stroke:var(--posStroke); stroke-width:5; opacity:.98; }
    .pos.empty{ cursor:pointer; }
    .pos.empty:hover{ stroke:#c7d2fe; }
    html[data-theme="light"] .pos.empty:hover{ stroke:#1d4ed8aa; }
    .sel{ stroke:#ffd166 !important; stroke-width:6 !important; }

    .stoneW{ fill:var(--orange); stroke:var(--orange2); stroke-width:3; }
    .stoneB{ fill:var(--navy); stroke:var(--navy2); stroke-width:3; }
    .stoneW, .stoneB{ pointer-events:none; }

    #overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); z-index:50; padding:18px;
    }
    #modal{
      width:min(520px, 92vw);
      background:linear-gradient(180deg,var(--modal1),var(--modal2));
      border:1px solid #4052b6; border-radius:18px; padding:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      text-align:center;
    }
    #modal h2{ margin:0 0 8px 0; font-size:34px; font-weight:950; }
    #modal p{ margin:0 0 14px 0; color:var(--muted); font-size:14px; }
    .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .ok{ border-color:rgba(255,255,255,.25); background:#6ee7b7; color:#052016; }
    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:60; display:none; }
    .warn{ color:#ffd166; }
    html[data-theme="light"] .warn{ color:#b45309; }

    .titleBar{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:6px;
    }
    .bigTitle{
      font-size:18px; font-weight:950; margin:0;
      text-transform:uppercase;
      letter-spacing:.2px;
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div id="overlay">
    <div id="modal">
      <h2 id="endTitle">Oyun bitti</h2>
      <p id="endText">â€”</p>
      <div class="btnRow">
        <button class="ok" id="playAgainBtn">Tekrar Dene</button>
        <button id="closeEndBtn">Kapat</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <div class="titleBar">
        <div>
          <p class="bigTitle">DÃœZCE Ä°SABET OKULLARI DOKUZ TAÅ OYUNU</p>
          <div class="small">AI (tek cihaz) veya Online (oda adÄ± ile iki kiÅŸi).</div>
        </div>
        <button id="themeBtn" style="white-space:nowrap;">ğŸŒ™ Koyu</button>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <div style="flex:1 1 260px">
          <div class="small">Ad Soyad</div>
          <input id="name" placeholder="Ã–rn: AyÅŸe YÄ±lmaz" autocomplete="name">
        </div>
        <div style="flex:0.7 1 160px">
          <div class="small">SÄ±nÄ±f/Åube</div>
          <input id="classroom" placeholder="Ã–rn: 5/A">
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="aiBtn">ğŸ¤– Bilgisayara KarÅŸÄ± (AI)</button>
        <span class="pill">Online aÅŸaÄŸÄ±da</span>
      </div>

      <div class="divider"></div>

      <!-- ONLINE -->
      <div class="card" style="background:var(--btn);">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1 1 220px">
            <div class="small">Oda AdÄ± (sen belirle)</div>
            <input id="roomName" placeholder="Ã–rn: 5A-MASA1 / ISABET-ODASI">
          </div>
          <button id="createRoomBtn">ğŸŒ Oda OluÅŸtur</button>
          <button id="joinRoomBtn">ğŸŒ Odaya Gir</button>
        </div>
        <div class="small" style="margin-top:8px">
          OdayÄ± oluÅŸturan <b>Turuncu</b>, odaya giren <b>Lacivert</b> olur. ArkadaÅŸÄ±n aynÄ± oda adÄ±nÄ± yazmalÄ±.
        </div>
        <div class="small warn" style="margin-top:8px" id="onlineHint"></div>
      </div>

      <div class="status" id="loginMsg"></div>
    </div>

    <!-- GAME -->
    <div class="grid2" id="gameUI" style="display:none">
      <div class="card" style="display:flex; align-items:center; justify-content:center;">
        <svg viewBox="0 0 1000 1000" aria-label="Dokuz taÅŸ tahtasÄ±">
          <rect x="100" y="100" width="800" height="800" fill="none" class="lineO"/>
          <rect x="250" y="250" width="500" height="500" fill="none" class="lineN"/>
          <rect x="400" y="400" width="200" height="200" fill="none" class="lineO"/>

          <line x1="500" y1="100" x2="500" y2="400" class="lineO"/>
          <line x1="500" y1="600" x2="500" y2="900" class="lineO"/>
          <line x1="100" y1="500" x2="400" y2="500" class="lineN"/>
          <line x1="600" y1="500" x2="900" y2="500" class="lineN"/>

          <g id="positions"></g>
        </svg>
      </div>

      <div class="card">
        <div class="titleBar">
          <div>
            <p class="bigTitle">DÃœZCE Ä°SABET OKULLARI DOKUZ TAÅ OYUNU</p>
            <div class="small">ResmÃ® kurallar â€¢ AI + Online</div>
          </div>
          <button id="themeBtn2" style="white-space:nowrap;">ğŸŒ™ Koyu</button>
        </div>

        <div class="row">
          <span class="pill" id="whoOrange">Turuncu: â€”</span>
          <span class="pill" id="whoNavy">Lacivert: â€”</span>
          <span class="pill" id="modePill">Mod: â€”</span>
          <span class="pill" id="phasePill">AÅŸama: â€”</span>
        </div>

        <div class="kpi">
          <div>Turuncu: Tahtada <b id="wOnBoard">0</b> / YerleÅŸen <b id="wPlaced">0</b></div>
          <div>Lacivert: Tahtada <b id="bOnBoard">0</b> / YerleÅŸen <b id="bPlaced">0</b></div>
        </div>

        <div class="status" id="status"></div>

        <div class="row">
          <button id="newBtn">Yeni Oyun</button>
          <button id="undoBtn">Geri Al</button>
          <button id="hintBtn">Ä°pucu</button>
        </div>

        <div class="row" id="aiDifficultyRow" style="margin-top:10px; display:none;">
          <span class="pill">Zorluk</span>
          <select id="difficulty">
            <option value="easy">Kolay</option>
            <option value="medium" selected>Orta</option>
            <option value="hard">Zor</option>
          </select>
          <span class="small">AI modu iÃ§in geÃ§erli</span>
        </div>

        <div class="divider"></div>
        <div class="small">
          â€¢ TaÅŸ koyma: boÅŸ noktaya dokun.<br>
          â€¢ Hareket: kendi taÅŸÄ±na dokun â†’ komÅŸu boÅŸ noktaya dokun.<br>
          â€¢ <b>UÃ§ma:</b> 3 taÅŸ kalÄ±nca istediÄŸin boÅŸ noktaya gidebilirsin.<br>
          â€¢ <b>DeÄŸirmen:</b> 3â€™lÃ¼ yapÄ±nca rakipten 1 taÅŸ alÄ±rsÄ±n (mÃ¼mkÃ¼nse deÄŸirmende olmayan).<br>
          â€¢ <b>Yasak:</b> AynÄ± hamle Ã¼st Ã¼ste / hemen geri hamle yok.
        </div>

        <div class="divider"></div>
        <div class="row">
          <span class="small"><b>Oda:</b> <span id="roomLabel">â€”</span></span>
          <span class="pill" id="onlineState">â€”</span>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  /* Tema */
  const themeBtn = document.getElementById("themeBtn");
  const themeBtn2 = document.getElementById("themeBtn2");

  function applyTheme(t){
    document.documentElement.setAttribute("data-theme", t);
    localStorage.setItem("theme", t);
    const label = (t==="dark") ? "ğŸŒ™ Koyu" : "â˜€ï¸ AÃ§Ä±k";
    themeBtn && (themeBtn.textContent = label);
    themeBtn2 && (themeBtn2.textContent = label);
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur==="dark" ? "light" : "dark");
  }
  applyTheme(localStorage.getItem("theme") || "dark");
  themeBtn?.addEventListener("click", toggleTheme);
  themeBtn2?.addEventListener("click", toggleTheme);

  /* structuredClone fallback */
  const clone = (obj) => (typeof structuredClone === "function") ? structuredClone(obj) : JSON.parse(JSON.stringify(obj));

  const $ = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const setLoginMsg = t => $("#loginMsg").textContent = t;
  const setStatus = t => $("#status").textContent = t;

  let difficulty = "medium";

  /* Firebase lazy */
  const firebaseConfig = {
    apiKey: "AIzaSyAYzorBVSTCcE3xzDZ9PyPprBdYEzKov3c",
    authDomain: "oyun-3bfba.firebaseapp.com",
    projectId: "oyun-3bfba",
    storageBucket: "oyun-3bfba.firebasestorage.app",
    messagingSenderId: "120738565998",
    appId: "1:120738565998:web:81876d89cafa64a1207b7f"
  };

  let fb=null;
  async function ensureFirebase(){
    if(fb) return fb;
    const appMod = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js");
    const fsMod  = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js");
    const app = appMod.initializeApp(firebaseConfig);
    const db  = fsMod.getFirestore(app);
    fb = {
      db,
      doc: fsMod.doc,
      setDoc: fsMod.setDoc,
      getDoc: fsMod.getDoc,
      updateDoc: fsMod.updateDoc,
      onSnapshot: fsMod.onSnapshot,
      collection: fsMod.collection,
      addDoc: fsMod.addDoc,
      serverTimestamp: fsMod.serverTimestamp
    };
    return fb;
  }

  /* Random */
  function randInt(n){
    if (window.crypto && crypto.getRandomValues) {
      const a = new Uint32Array(1);
      crypto.getRandomValues(a);
      return a[0] % n;
    }
    return Math.floor(Math.random()*n);
  }
  function pickRandom(arr){ return arr[arr.length ? randInt(arr.length) : 0]; }

  /* Tahta */
  const POS = [
    [100,100],[500,100],[900,100],
    [250,250],[500,250],[750,250],
    [400,400],[500,400],[600,400],
    [100,500],[250,500],[400,500],[600,500],[750,500],[900,500],
    [400,600],[500,600],[600,600],
    [250,750],[500,750],[750,750],
    [100,900],[500,900],[900,900]
  ];

  const ADJ = [
    [1,9],[0,2,4],[1,14],[4,10],[1,3,5,7],[4,13],[7,11],[4,6,8],[7,12],
    [0,10,21],[3,9,11,18],[6,10,15],[8,13,17],[5,12,14,20],[2,13,23],
    [11,16],[15,17,19],[12,16],[10,19],[16,18,20,22],[13,19],[9,22],[19,21,23],[14,22]
  ];

  const MILLS = [
    [0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,13,14],[15,16,17],[18,19,20],[21,22,23],
    [0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],[5,13,20],[2,14,23]
  ];

  const positionsG = document.getElementById("positions");

  function freshGame(){
    return {
      board: Array(24).fill(null),
      placed: {W:0, B:0},
      turn: 'W',
      capture: null,
      winner: null,
      lastMove: { W:null, B:null }
    };
  }

  let mode = "AI";         // "AI" | "ONLINE"
  let roomId = null;
  let role = "HOST";       // HOST -> W, GUEST -> B
  let unsubRoom = null;

  let selected = null;
  let game = freshGame();
  let history = [];

  function myPlayer(){
    if(mode==="AI") return 'W';
    return role==="HOST" ? 'W' : 'B';
  }

  function countOnBoard(b,p){ return b.filter(x=>x===p).length; }
  function phaseOf(state,p){ return state.placed[p] < 9 ? "placing" : "moving"; }
  function canFly(state,p){ return phaseOf(state,p)==="moving" && countOnBoard(state.board,p) <= 3; }

  function millsFormedBy(board, p, posIndex){
    return MILLS.filter(m => m.includes(posIndex) && m.every(i => board[i]===p));
  }
  function isInAnyMill(board, p, idx){
    return MILLS.some(m => m.includes(idx) && m.every(i => board[i]===p));
  }
  function removableOpponentStones(board, opponent){
    const oppIdx = board.map((v,i)=> v===opponent ? i : -1).filter(i=>i>=0);
    const notInMill = oppIdx.filter(i => !isInAnyMill(board, opponent, i));
    return notInMill.length ? notInMill : oppIdx;
  }
  function hasAnyLegalMove(state, p){
    const b = state.board;
    if(phaseOf(state,p)==="placing") return b.some(x=>x===null);
    const fly = canFly(state,p);
    const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);
    if(fly) return b.some(x=>x===null) && my.length>0;
    for(const from of my){
      if(ADJ[from].some(to => b[to]===null)) return true;
    }
    return false;
  }
  function checkWinner(state){
    if (state.placed.W < 9 || state.placed.B < 9) return null;
    const wCount = countOnBoard(state.board,'W');
    const bCount = countOnBoard(state.board,'B');
    if (wCount < 3 || !hasAnyLegalMove(state,'W')) return 'B';
    if (bCount < 3 || !hasAnyLegalMove(state,'B')) return 'W';
    return null;
  }

  function violatesRepeat(state, p, from, to){
    const lm = state.lastMove[p];
    if(!lm) return false;
    const same = lm.from===from && lm.to===to;
    const rev  = lm.from===to && lm.to===from;
    return same || rev;
  }
  function rememberMove(state, p, from, to){
    state.lastMove[p] = {from, to};
  }

  function applyPlace(state, p, to){
    if(state.winner) return null;
    if(state.capture) return null;
    if(phaseOf(state,p)!=="placing") return null;
    if(state.turn!==p) return null;
    if(state.board[to]!==null) return null;

    const s = clone(state);
    s.board[to]=p;
    s.placed[p]++;

    const millMade = millsFormedBy(s.board,p,to).length>0;
    if(millMade){
      const opp = p==='W'?'B':'W';
      const removable = removableOpponentStones(s.board, opp);
      s.capture = { by:p, pending:{type:'place', from:null, to}, removable };
    }else{
      s.turn = (p==='W'?'B':'W');
    }
    s.winner = checkWinner(s);
    return s;
  }

  function applyMove(state, p, from, to){
    if(state.winner) return null;
    if(state.capture) return null;
    if(phaseOf(state,p)!=="moving") return null;
    if(state.turn!==p) return null;
    if(state.board[from]!==p) return null;
    if(state.board[to]!==null) return null;

    const fly = canFly(state,p);
    if(!fly && !ADJ[from].includes(to)) return null;

    if(violatesRepeat(state,p,from,to)) return null;

    const s = clone(state);
    s.board[from]=null;
    s.board[to]=p;
    rememberMove(s,p,from,to);

    const millMade = millsFormedBy(s.board,p,to).length>0;
    if(millMade){
      const opp = p==='W'?'B':'W';
      const removable = removableOpponentStones(s.board, opp);
      s.capture = { by:p, pending:{type:'move', from, to}, removable };
    }else{
      s.turn = (p==='W'?'B':'W');
    }
    s.winner = checkWinner(s);
    return s;
  }

  function applyCapture(state, p, capIndex){
    if(state.winner) return null;
    if(!state.capture) return null;
    if(state.capture.by !== p) return null;
    if(state.turn !== p) return null;

    const s = clone(state);
    const opp = p==='W'?'B':'W';
    if(s.board[capIndex]!==opp) return null;
    if(!s.capture.removable.includes(capIndex)) return null;

    s.board[capIndex]=null;
    s.capture = null;
    s.turn = opp;
    s.winner = checkWinner(s);
    return s;
  }

  function updateKPI(){
    $("#wOnBoard").textContent = countOnBoard(game.board,'W');
    $("#bOnBoard").textContent = countOnBoard(game.board,'B');
    $("#wPlaced").textContent = game.placed.W;
    $("#bPlaced").textContent = game.placed.B;

    const phase = (game.placed.W<9 || game.placed.B<9) ? "TaÅŸ koyma" : "Hareket";
    $("#phasePill").textContent = "AÅŸama: " + phase;

    $("#modePill").textContent = "Mod: " + (mode==="ONLINE" ? "Online" : "AI");
    $("#undoBtn").disabled = (mode==="ONLINE") || history.length<=1 || !!game.winner;
    $("#hintBtn").disabled = (mode!=="AI") || (game.turn!==myPlayer()) || !!game.winner || !!game.capture;

    const row = document.getElementById("aiDifficultyRow");
    if(row) row.style.display = (mode==="AI") ? "flex" : "none";
  }

  function render(){
    positionsG.innerHTML = "";
    for(let i=0;i<24;i++){
      const [x,y] = POS[i];
      const v = game.board[i];

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", x);
      c.setAttribute("cy", y);
      c.setAttribute("r", 38);
      c.classList.add("pos");
      if(v===null) c.classList.add("empty");
      if(selected===i) c.classList.add("sel");
      c.addEventListener("click", ()=> onClickPos(i));
      g.appendChild(c);

      if(v!==null){
        const s = document.createElementNS("http://www.w3.org/2000/svg","circle");
        s.setAttribute("cx", x);
        s.setAttribute("cy", y);
        s.setAttribute("r", 18);
        s.classList.add(v==='W' ? "stoneW" : "stoneB");
        g.appendChild(s);
      }

      positionsG.appendChild(g);
    }

    if(mode==="ONLINE"){
      if(role==="HOST"){
        $("#whoOrange").textContent = "Turuncu: Sen (Host)";
        $("#whoNavy").textContent = "Lacivert: Rakip (Guest)";
      }else{
        $("#whoOrange").textContent = "Turuncu: Rakip (Host)";
        $("#whoNavy").textContent = "Lacivert: Sen (Guest)";
      }
      $("#onlineState").textContent = "Online";
      $("#roomLabel").textContent = roomId || "â€”";
    }else{
      $("#whoOrange").textContent = "Turuncu: Sen";
      $("#whoNavy").textContent = "Lacivert: AI";
      $("#onlineState").textContent = "â€”";
      $("#roomLabel").textContent = "â€”";
    }
    updateKPI();
  }

  /* End + Confetti */
  function showEnd(win){
    $("#endTitle").textContent = win ? "KAZANDIN! ğŸ‰" : "KAYBETTÄ°N ğŸ˜•";
    $("#endText").textContent = win ? "Tebrikler! Tekrar oynamak iÃ§in â€œTekrar Deneâ€." : "Tekrar dene. â€œTekrar Deneâ€ye bas.";
    $("#overlay").style.display = "flex";
    if(win) startConfetti(); else stopConfetti();
  }
  function hideEnd(){
    $("#overlay").style.display = "none";
    stopConfetti();
  }
  $("#playAgainBtn").addEventListener("click", ()=> newGame());
  $("#closeEndBtn").addEventListener("click", ()=> hideEnd());

  const conf = $("#confetti");
  const ctx = conf.getContext("2d");
  let confOn=false;
  let pieces=[];
  function resizeConf(){
    conf.width = window.innerWidth * devicePixelRatio;
    conf.height = window.innerHeight * devicePixelRatio;
    conf.style.width = window.innerWidth + "px";
    conf.style.height = window.innerHeight + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeConf);
  function startConfetti(){
    resizeConf();
    conf.style.display="block";
    confOn=true;
    pieces = Array.from({length:180}).map(()=>({
      x: Math.random()*window.innerWidth,
      y: -20 - Math.random()*window.innerHeight*0.4,
      r: 3 + Math.random()*5,
      vx: -1.2 + Math.random()*2.4,
      vy: 2 + Math.random()*4.5,
      rot: Math.random()*Math.PI,
      vr: -0.15 + Math.random()*0.3,
      hue: Math.random()*360
    }));
    tickConfetti();
  }
  function stopConfetti(){
    confOn=false;
    conf.style.display="none";
  }
  function tickConfetti(){
    if(!confOn) return;
    ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
    for(const p of pieces){
      p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.vy += 0.02;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = `hsl(${p.hue} 85% 60%)`;
      ctx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.2);
      ctx.restore();
      if(p.y > window.innerHeight + 40){
        p.y = -20; p.x = Math.random()*window.innerWidth; p.vy = 2 + Math.random()*4.5;
      }
    }
    requestAnimationFrame(tickConfetti);
  }

  /* History (AI only) */
  function pushHistory(){ history.push(clone(game)); }
  function undo(){
    if(mode==="ONLINE") return;
    if(history.length<=1) return;
    history.pop();
    game = clone(history[history.length-1]);
    selected = null;
    render();
    setStatus("Geri alÄ±ndÄ±. SÄ±ra sende.");
  }

  /* Commit */
  async function commit(next){
    if(!next) return;
    game = next;
    selected = null;

    if(mode==="ONLINE"){
      const { db, doc, updateDoc, serverTimestamp } = await ensureFirebase();
      const r = doc(db,"rooms",roomId);
      await updateDoc(r, { game, updatedAt: serverTimestamp() });
      render();
      if(game.winner) showEnd(game.winner===myPlayer());
      return;
    }

    pushHistory();
    render();
    if(game.winner){ showEnd(game.winner===myPlayer()); return; }

    await maybeAIMove();
    render();
    if(game.winner) showEnd(game.winner===myPlayer());
  }

  /* Click */
  async function onClickPos(i){
    if(game.winner) return;

    const me = myPlayer();

    if(game.capture){
      if(game.capture.by !== me){ setStatus("TaÅŸ alma sÄ±rasÄ± sende deÄŸil."); return; }
      const next = applyCapture(game, me, i);
      if(!next){ setStatus("GeÃ§ersiz taÅŸ alma. (DeÄŸirmende olmayan taÅŸ seÃ§.)"); return; }
      await commit(next);
      setStatus("TaÅŸ alÄ±ndÄ±. Rakip sÄ±rasÄ±.");
      return;
    }

    if(game.turn !== me){ setStatus("SÄ±ra sende deÄŸil."); return; }

    if(phaseOf(game,me)==="placing"){
      const next = applyPlace(game, me, i);
      if(!next){ setStatus("Oraya koyamazsÄ±n."); return; }
      await commit(next);
      if(next.capture) setStatus("DeÄŸirmen yaptÄ±n! Rakibin bir taÅŸÄ±nÄ± kaldÄ±r.");
      else setStatus("Hamle yapÄ±ldÄ±.");
      return;
    }

    if(game.board[i]===me){
      selected = (selected===i ? null : i);
      render();
      if(selected!==null){
        setStatus(canFly(game,me) ? "TaÅŸ seÃ§ildi. UÃ§ma var: herhangi bir boÅŸ noktaya dokun." : "TaÅŸ seÃ§ildi. KomÅŸu boÅŸ noktaya dokun.");
      }else{
        setStatus("SÄ±ra sende.");
      }
      return;
    }

    if(game.board[i]===null && selected!==null){
      const from = selected;
      const next = applyMove(game, me, from, i);
      if(!next){ setStatus("GeÃ§ersiz hamle. (KomÅŸu olmalÄ± / uÃ§ma / aynÄ± hamle yasak.)"); return; }
      await commit(next);
      if(next.capture) setStatus("DeÄŸirmen yaptÄ±n! Rakibin bir taÅŸÄ±nÄ± kaldÄ±r.");
      else setStatus("Hamle yapÄ±ldÄ±.");
    }
  }

  /* =========================
     SERÄ° AI (DONMA YOK) âœ…
     - Zaman limiti + yedek hamle
     ========================= */
  function countMills(board, p){ return MILLS.filter(m => m.every(i => board[i]===p)).length; }
  function potentialMills(board, p){
    let c=0;
    for(const m of MILLS){
      let pc=0, ec=0;
      for(const i of m){
        if(board[i]===p) pc++;
        else if(board[i]===null) ec++;
      }
      if(pc===2 && ec===1) c++;
    }
    return c;
  }
  function mobility(state, p){
    const ph = phaseOf(state,p);
    if(ph==="placing") return 0;
    if(canFly(state,p)) return state.board.filter(v=>v===null).length;
    let moves=0;
    for(let i=0;i<24;i++){
      if(state.board[i]!==p) continue;
      moves += ADJ[i].filter(j => state.board[j]===null).length;
    }
    return moves;
  }

  function generateAllActions(state, p){
    const actions = [];
    const ph = phaseOf(state,p);

    if(state.capture){
      if(state.capture.by !== p) return actions;
      for(const cap of state.capture.removable) actions.push({type:'capture', cap});
      return actions;
    }

    if(ph==="placing"){
      for(let to=0; to<24; to++) if(state.board[to]===null) actions.push({type:'place', to});
      return actions;
    }

    const fly = canFly(state,p);
    for(let from=0; from<24; from++){
      if(state.board[from]!==p) continue;
      const targets = fly
        ? state.board.map((v,i)=> v===null?i:-1).filter(x=>x>=0)
        : ADJ[from].filter(to => state.board[to]===null);

      for(const to of targets){
        if(violatesRepeat(state,p,from,to)) continue;
        actions.push({type:'move', from, to});
      }
    }
    return actions;
  }

  function simulate(state, p, action){
    if(action.type==='place') return applyPlace(state,p,action.to);
    if(action.type==='move')  return applyMove(state,p,action.from,action.to);
    if(action.type==='capture') return applyCapture(state,p,action.cap);
    return null;
  }

  function evalStateStrong(state){
    const b = state.board;
    if(state.winner==='B') return  1e9;
    if(state.winner==='W') return -1e9;

    const w = countOnBoard(b,'W');
    const bl = countOnBoard(b,'B');

    const millsW = countMills(b,'W');
    const millsB = countMills(b,'B');

    const potW = potentialMills(b,'W');
    const potB = potentialMills(b,'B');

    const mobW = mobility(state,'W');
    const mobB = mobility(state,'B');

    let score = (bl - w) * 140;
    score += (millsB - millsW) * 95;
    score += (potB - potW) * 28;
    score += (mobB - mobW) * 6;

    return score;
  }

  function minimaxTimed(state, depth, alpha, beta, maximizingForB, deadline){
    if(performance.now() > deadline) return {score: evalStateStrong(state), action:null};
    if(depth===0 || state.winner) return {score: evalStateStrong(state), action:null};

    const p = maximizingForB ? 'B' : 'W';
    let actions = generateAllActions(state,p);
    if(!actions.length) return {score: evalStateStrong(state), action:null};

    const cap = actions.filter(a=>a.type==='capture');
    if(cap.length) actions = cap;

    // HÄ±z iÃ§in basit sÄ±ralama
    actions.sort((a,b)=>{
      const ra = (a.type==='capture'?1000:0) + (a.type==='move'?40:0) + (a.type==='place'?20:0);
      const rb = (b.type==='capture'?1000:0) + (b.type==='move'?40:0) + (b.type==='place'?20:0);
      return rb-ra;
    });

    let bestAction=null;

    if(maximizingForB){
      let best=-Infinity;
      for(const act of actions){
        if(performance.now() > deadline) break;
        const next = simulate(state,'B',act);
        if(!next) continue;
        const res = minimaxTimed(next, depth-1, alpha, beta, false, deadline);
        if(res.score>best){ best=res.score; bestAction=act; }
        alpha = Math.max(alpha,best);
        if(beta<=alpha) break;
      }
      return {score:best, action:bestAction};
    }else{
      let best=Infinity;
      for(const act of actions){
        if(performance.now() > deadline) break;
        const next = simulate(state,'W',act);
        if(!next) continue;
        const res = minimaxTimed(next, depth-1, alpha, beta, true, deadline);
        if(res.score<best){ best=res.score; bestAction=act; }
        beta = Math.min(beta,best);
        if(beta<=alpha) break;
      }
      return {score:best, action:bestAction};
    }
  }

  function pickBestHeuristic(state, p, actions){
    // â€œDonma yokâ€ yedek: tek hamle ileri bakÄ±p en iyi puanÄ± seÃ§
    const scored = actions.map(a=>{
      const s2 = simulate(state, p, a);
      return {a, sc: s2 ? evalStateStrong(s2) : -1e15};
    }).sort((x,y)=> y.sc - x.sc);

    // biraz Ã§eÅŸitlilik: ilk 4â€™ten rastgele seÃ§ (ama iyi hamlelerden)
    const topN = Math.min(4, scored.length);
    const top = scored.slice(0, topN).map(x=>x.a);
    return pickRandom(top) || scored[0]?.a || null;
  }

  async function maybeAIMove(){
    if(mode!=="AI") return;
    if(game.winner) return;
    if(game.turn!=='B') return;

    setStatus("AI dÃ¼ÅŸÃ¼nÃ¼yor...");
    // UI'nin â€œtakÄ±lmamasÄ±â€ iÃ§in Ã§ok kÄ±sa bekleme
    await sleep(60);

    // Capture varsa Ã§ok hÄ±zlÄ± seÃ§
    if(game.capture && game.capture.by==='B'){
      const caps = game.capture.removable;
      let bestCap = caps[0];
      let bestScore = -Infinity;
      for(const cap of caps){
        const next = applyCapture(game,'B',cap);
        if(!next) continue;
        const sc = evalStateStrong(next);
        if(sc > bestScore){ bestScore = sc; bestCap = cap; }
      }
      const next = applyCapture(game,'B',bestCap);
      if(next){
        game = next; pushHistory(); render();
        if(game.winner) showEnd(false);
        else setStatus("AI taÅŸ aldÄ±. SÄ±ra sende.");
      }
      return;
    }

    const allActs = generateAllActions(game,'B');
    if(!allActs.length){
      game.winner = 'W';
      render();
      showEnd(true);
      return;
    }

    // âœ… Telefonlar iÃ§in sÃ¼re limiti (donma yok)
    // Kolay: 70ms, Orta: 110ms, Zor: 170ms
    const timeBudget =
      (difficulty==="easy") ? 70 :
      (difficulty==="medium") ? 110 : 170;

    // Derinlikleri de mobil uyumlu tuttuk
    const bCount = countOnBoard(game.board,'B');
    let depth =
      (difficulty==="easy") ? 2 :
      (difficulty==="medium") ? (bCount<=3 ? 3 : 3) :
      (bCount<=3 ? 4 : 4);

    // Zor bile olsa 4â€™Ã¼ aÅŸmÄ±yoruz (telefon donmasÄ±n)
    depth = Math.min(depth, 4);

    // Blunder (kolay/orta)
    const blunderRate = (difficulty==="easy") ? 0.30 : (difficulty==="medium") ? 0.12 : 0.03;

    let chosen=null;

    try{
      const deadline = performance.now() + timeBudget;
      const res = minimaxTimed(game, depth, -Infinity, Infinity, true, deadline);
      chosen = res.action;
    }catch(e){
      console.warn("AI minimax hata, yedek hamle:", e);
      chosen = null;
    }

    // SÃ¼re bitti / action yoksa: yedek hÄ±zlÄ± hamle
    if(!chosen){
      chosen = pickBestHeuristic(game,'B',allActs);
    }

    // Kolay/Orta: bazen daha kÃ¶tÃ¼ hamle seÃ§sin (ama yine hÄ±zlÄ±)
    if(Math.random() < blunderRate && allActs.length>4){
      chosen = pickRandom(allActs) || chosen;
    }

    const next = chosen ? simulate(game,'B',chosen) : null;
    if(next){
      game = next; pushHistory(); render();
      // arka arkaya capture gerekirse seri devam
      if(game.capture && game.capture.by==='B') return maybeAIMove();
      if(game.winner) showEnd(false);
      else setStatus("AI hamle yaptÄ±. SÄ±ra sende.");
    }else{
      // En kÃ¶tÃ¼ ihtimal: random hamle
      const fallback = pickRandom(allActs);
      const next2 = fallback ? simulate(game,'B',fallback) : null;
      if(next2){
        game = next2; pushHistory(); render();
        if(game.capture && game.capture.by==='B') return maybeAIMove();
        if(game.winner) showEnd(false);
        else setStatus("AI hamle yaptÄ±. SÄ±ra sende.");
      }else{
        game.winner = 'W';
        render();
        showEnd(true);
      }
    }
  }

  function hint(){
    if(mode!=="AI") return;
    if(game.winner) return;
    if(game.turn!==myPlayer()) return;
    if(game.capture) { setStatus("Ã–nce taÅŸ alman gerekiyor."); return; }

    const actions = generateAllActions(game,'W');
    const best = pickBestHeuristic(game,'W',actions);
    if(!best){ setStatus("Ä°pucu bulunamadÄ±."); return; }
    if(best.type==='place') setStatus(`Ä°pucu: ${best.to+1}. noktaya taÅŸ koy.`);
    if(best.type==='move') setStatus(`Ä°pucu: ${best.from+1} â†’ ${best.to+1}.`);
    if(best.type==='capture') setStatus(`Ä°pucu: ${best.cap+1}. taÅŸÄ± al.`);
  }

  function openGameUI(){
    $("#loginCard").style.display="none";
    $("#gameUI").style.display="grid";
    render();
  }

  async function logSession(extra={}){
    try{
      const { db, collection, addDoc, serverTimestamp } = await ensureFirebase();
      const name = $("#name").value.trim();
      const classroom = $("#classroom").value.trim();
      await addDoc(collection(db,"sessions"),{
        name, classroom,
        createdAt: serverTimestamp(),
        userAgent: navigator.userAgent,
        ...extra
      });
    }catch(e){ /* log ÅŸart deÄŸil */ }
  }

  function validateLogin(){
    const name = $("#name").value.trim();
    const classroom = $("#classroom").value.trim();
    if(!name || !classroom){
      setLoginMsg("Ad Soyad ve SÄ±nÄ±f/Åube zorunlu.");
      return null;
    }
    return {name, classroom};
  }

  function normalizeRoomName(raw){
    return raw.trim().toUpperCase().replace(/\s+/g,'-');
  }

  $("#aiBtn").addEventListener("click", async ()=>{
    const info = validateLogin();
    if(!info) return;

    mode="AI"; role="HOST"; roomId=null;
    game = freshGame(); history=[]; selected=null; pushHistory();

    await logSession({mode:"AI"});
    openGameUI();
    setStatus("SÄ±ra sende. BoÅŸ bir noktaya taÅŸ koy.");
  });

  async function createRoom(){
    const info = validateLogin();
    if(!info) return;

    const roomNameRaw = $("#roomName").value;
    const roomName = normalizeRoomName(roomNameRaw);
    if(!roomName){ setLoginMsg("Oda adÄ± yaz."); return; }

    const { db, doc, setDoc, getDoc, serverTimestamp } = await ensureFirebase();

    mode="ONLINE"; role="HOST";
    roomId = roomName;

    await logSession({mode:"ONLINE_CREATE", roomId});

    const r = doc(db,"rooms",roomId);
    const snap = await getDoc(r);

    if(snap.exists()){
      await listenRoom();
      openGameUI();
      setStatus("Bu oda zaten var. Host olarak baÄŸlanÄ±ldÄ±: " + roomId);
      return;
    }

    await setDoc(r, {
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      host: { name: info.name, classroom: info.classroom, joinedAt: serverTimestamp() },
      guest: null,
      game: freshGame()
    });

    await listenRoom();
    openGameUI();
    setStatus("Oda oluÅŸturuldu: " + roomId + " (ArkadaÅŸÄ±n aynÄ± oda adÄ±nÄ± yazÄ±p girsin)");
  }

  async function joinRoom(){
    const info = validateLogin();
    if(!info) return;

    const roomNameRaw = $("#roomName").value;
    const roomName = normalizeRoomName(roomNameRaw);
    if(!roomName){ setLoginMsg("Oda adÄ± yaz."); return; }

    const { db, doc, getDoc, updateDoc, serverTimestamp } = await ensureFirebase();

    mode="ONLINE"; role="GUEST"; roomId=roomName;

    const r = doc(db,"rooms",roomId);
    const snap = await getDoc(r);
    if(!snap.exists()){
      setLoginMsg("Bu oda bulunamadÄ±: " + roomId);
      return;
    }

    await logSession({mode:"ONLINE_JOIN", roomId});

    await updateDoc(r, {
      guest: { name: info.name, classroom: info.classroom, joinedAt: serverTimestamp() },
      updatedAt: serverTimestamp()
    });

    await listenRoom();
    openGameUI();
    setStatus("Odaya girdin: " + roomId);
  }

  $("#createRoomBtn").addEventListener("click", ()=> createRoom().catch(e=>{
    console.error(e);
    setLoginMsg("Online oda oluÅŸturulamadÄ±. Firestore / Rules kontrol et.");
  }));
  $("#joinRoomBtn").addEventListener("click", ()=> joinRoom().catch(e=>{
    console.error(e);
    setLoginMsg("Online odaya girilemedi. Firestore / Rules kontrol et.");
  }));

  async function listenRoom(){
    const { db, doc, onSnapshot } = await ensureFirebase();

    if(unsubRoom) { unsubRoom(); unsubRoom=null; }
    const r = doc(db,"rooms",roomId);

    unsubRoom = onSnapshot(r, (snap)=>{
      if(!snap.exists()) return;
      const data = snap.data();

      if(data.game){
        game = data.game;
        history = [clone(game)];
        selected = null;
        render();

        if(game.winner){
          showEnd(game.winner===myPlayer());
          return;
        }

        const me = myPlayer();
        if(game.capture && game.capture.by===me){
          setStatus("DeÄŸirmen yaptÄ±n! Rakibin bir taÅŸÄ±nÄ± kaldÄ±r.");
        }else if(game.capture){
          setStatus("Rakip taÅŸ alÄ±yor...");
        }else{
          setStatus(game.turn===me ? "SÄ±ra sende." : "Rakip oynuyor...");
        }
      }

      const host = data.host?.name ? "Host: " + data.host.name : "Host: â€”";
      const guest = data.guest?.name ? "Guest: " + data.guest.name : "Guest: bekleniyorâ€¦";
      $("#onlineState").textContent = data.guest?.name ? "HazÄ±r" : "Rakip bekleniyorâ€¦";
      $("#roomLabel").textContent = (roomId || "â€”") + " â€¢ " + host + " â€¢ " + guest;
    }, (err)=>{
      console.error(err);
      setStatus("Online dinleme hatasÄ±. Firestore kurallarÄ±nÄ± kontrol et.");
    });
  }

  async function newGame(){
    hideEnd();

    if(mode==="AI"){
      game = freshGame(); history=[]; selected=null; pushHistory();
      render();
      setStatus("Yeni oyun. SÄ±ra sende.");
      return;
    }

    if(role!=="HOST"){
      setStatus("Onlineâ€™da yeni oyunu Host baÅŸlatÄ±r.");
      return;
    }

    const { db, doc, updateDoc, serverTimestamp } = await ensureFirebase();
    const r = doc(db,"rooms",roomId);
    await updateDoc(r, { game: freshGame(), updatedAt: serverTimestamp() });
    setStatus("Yeni oyun baÅŸlatÄ±ldÄ±.");
  }

  $("#newBtn").addEventListener("click", ()=> newGame().catch(console.error));
  $("#undoBtn").addEventListener("click", undo);
  $("#hintBtn").addEventListener("click", hint);

  const diffEl = document.getElementById("difficulty");
  diffEl?.addEventListener("change",(e)=>{
    difficulty = e.target.value;
    if(mode==="AI"){
      const t = (difficulty==="easy") ? "Kolay" : (difficulty==="medium") ? "Orta" : "Zor";
      setStatus("Zorluk seÃ§ildi: " + t);
    }
  });

  render();
  setLoginMsg("");
</script>
</body>
</html>
