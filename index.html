<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokuz Ta≈ü | AI + Online Oda (Resm√Æ)</title>

  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root { --bg:#0b1020; --panel:#121a33; --line:#93a4ff55; --text:#e9edff; --muted:#b9c2ff; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ display:flex; flex-direction:column; gap:12px; padding:14px; max-width:1100px; margin:0 auto; }
    .top{ display:flex; flex-wrap:wrap; gap:12px; align-items:stretch; }
    .card{ background:var(--panel); border:1px solid #2a3570; border-radius:14px; padding:12px; }
    .boardCard{ flex: 1 1 560px; display:flex; align-items:center; justify-content:center; }
    .infoCard{ flex: 1 1 340px; min-width:320px; }
    h1{ font-size:18px; margin:0 0 8px 0; font-weight:900; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button{
      border:1px solid #2a3570; background:#0f1630; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:850;
    }
    button:hover{ border-color:#4052b6; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    input{
      width:100%; box-sizing:border-box;
      border:1px solid #2a3570; background:#0f1630; color:var(--text);
      padding:12px; border-radius:12px;
    }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#0f1630; border:1px solid #2a3570; color:var(--muted); font-size:12px; }
    .status{ margin-top:10px; line-height:1.35; color:var(--muted); min-height:46px; white-space:pre-line; }
    .hint{ margin-top:10px; font-size:12px; color:#c9d0ff; opacity:.95; }
    .kpi{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
    .kpi div{ background:#0f1630; border:1px solid #2a3570; border-radius:12px; padding:10px; font-size:13px; color:var(--muted); }
    .kpi b{ color:var(--text); }
    .small{ font-size:12px; color:var(--muted); }

    svg{ width:min(88vw, 620px); height:auto; }
    .line{ stroke:var(--line); stroke-width:8; stroke-linecap:round; }
    .pos{ fill:#0f1630; stroke:#2a3570; stroke-width:3; }
    .pos:hover{ stroke:#6e84ff; }
    .pos.empty{ cursor:pointer; }

    /* ‚úÖ RENKLER */
    .stoneW{ fill:#f59e0b; stroke:#ffd08a; stroke-width:3; }     /* Turuncu (W) */
    .stoneB{ fill:#0b3a8a; stroke:#7aa2ff; stroke-width:3; }     /* Lacivert (B) */
    .stoneW, .stoneB { pointer-events:none; } /* dokunma sorununu azaltƒ±r */

    .sel{ stroke:#ffd166; stroke-width:5; }
    .glow{ filter:url(#glow); }
    .divider{ height:1px; background:#24306a; margin:10px 0; }

    /* ‚úÖ SONU√á OVERLAY */
    .overlay{
      display:none;
      position:fixed; inset:0;
      background:rgba(0,0,0,.82);
      backdrop-filter: blur(8px);
      align-items:center; justify-content:center;
      z-index:99999;
    }
    .overlayBox{
      width:min(94vw,680px);
      border-radius:26px;
      padding:26px;
      border:2px solid #4052b6;
      background:#121a33;
      text-align:center;
      box-shadow: 0 20px 80px rgba(0,0,0,.60);
    }
    .bigTitle{
      font-size: clamp(40px, 8vw, 80px);
      font-weight: 1000;
      letter-spacing: 1px;
      margin: 0 0 10px 0;
      text-transform: uppercase;
    }
    .subLine{
      font-size: clamp(16px, 2.8vw, 22px);
      color: #c9d0ff;
      margin: 0 0 18px 0;
      line-height: 1.4;
    }
    .endIcon{ font-size:64px; margin-bottom:8px; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ‚úÖ Gƒ∞Rƒ∞≈û -->
  <div class="card" id="loginCard">
    <h1>Dokuz Ta≈ü ‚Äì Giri≈ü</h1>
    <div class="small">AI veya Online Oda se√ßebilirsin. Online‚Äôda Host=Turuncu, Guest=Lacivert.</div>
    <div style="height:10px"></div>

    <label class="small">Ad Soyad</label>
    <input id="name" placeholder="√ñrn: Ay≈üe Yƒ±lmaz" autocomplete="name"/>
    <div style="height:10px"></div>

    <label class="small">Sƒ±nƒ±f / ≈ûube</label>
    <input id="classroom" placeholder="√ñrn: 5/A"/>
    <div style="height:12px"></div>

    <div class="row">
      <button id="startAI">Bilgisayara Kar≈üƒ± (AI)</button>
      <button id="toggleOnline">Online Rakip</button>
    </div>

    <div id="onlinePanel" style="display:none; margin-top:12px;">
      <div class="divider"></div>
      <div class="row">
        <button id="createRoom">Oda Olu≈ütur</button>
        <button id="joinRoomBtn">Koda Katƒ±l</button>
      </div>
      <div style="height:10px"></div>
      <label class="small">Oda Kodu</label>
      <input id="roomCode" placeholder="√ñrn: AB12CD" style="text-transform:uppercase"/>
      <div class="status" id="loginMsg"></div>
    </div>

    <div class="status" id="loginMsgMain"></div>
  </div>

  <!-- ‚úÖ OYUN -->
  <div class="top" id="gameUI" style="display:none">
    <div class="card boardCard">
      <svg viewBox="0 0 1000 1000" aria-label="Dokuz ta≈ü tahtasƒ±">
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>

        <!-- 3 kare -->
        <rect x="100" y="100" width="800" height="800" fill="none" class="line"/>
        <rect x="250" y="250" width="500" height="500" fill="none" class="line"/>
        <rect x="400" y="400" width="200" height="200" fill="none" class="line"/>

        <!-- orta baƒülantƒ±lar -->
        <line x1="500" y1="100" x2="500" y2="400" class="line"/>
        <line x1="500" y1="600" x2="500" y2="900" class="line"/>
        <line x1="100" y1="500" x2="400" y2="500" class="line"/>
        <line x1="600" y1="500" x2="900" y2="500" class="line"/>

        <g id="positions"></g>
      </svg>
    </div>

    <div class="card infoCard">
      <h1>Durum Paneli</h1>
      <div class="row" style="margin-bottom:6px;">
        <span class="pill" id="modePill">Mod: -</span>
        <span class="pill" id="youPill">Sen: -</span>
        <span class="pill" id="roomPill" style="display:none;">Oda: -</span>
      </div>
      <div class="row">
        <span class="pill">Turuncu (W)</span>
        <span class="pill">Lacivert (B)</span>
        <span class="pill" id="phasePill">A≈üama: Ta≈ü koyma</span>
      </div>

      <div class="kpi">
        <div>Turuncu: Tahtada <b id="wOnBoard">0</b> / Yerle≈üen <b id="wPlaced">0</b></div>
        <div>Lacivert: Tahtada <b id="bOnBoard">0</b> / Yerle≈üen <b id="bPlaced">0</b></div>
      </div>

      <div class="status" id="status"></div>

      <div class="row" style="margin-top:10px;">
        <button id="newBtn">Yeni Oyun</button>
        <button id="undoBtn">Geri Al</button>
        <button id="hintBtn">ƒ∞pucu</button>
        <button id="leaveBtn">√áƒ±k</button>
      </div>

      <div class="divider"></div>

      <div class="hint">
        <div class="small">Kƒ±sa kullanƒ±m:</div>
        <ul class="small" style="margin:6px 0 0 18px; padding:0;">
          <li><b>Ta≈ü koyma:</b> bo≈ü noktaya dokun.</li>
          <li><b>Hareket:</b> kendi ta≈üƒ±na dokun ‚Üí kom≈üu bo≈ü noktaya dokun.</li>
          <li><b>U√ßma:</b> 3 ta≈ü kalƒ±nca istediƒüin bo≈ü noktaya gidebilirsin.</li>
          <li><b>Deƒüirmen:</b> 3‚Äôl√º yapƒ±nca rakipten 1 ta≈ü kaldƒ±rƒ±rsƒ±n (m√ºmk√ºnse deƒüirmende olmayan).</li>
        </ul>
        <div class="small" style="margin-top:8px;">
          Online‚Äôda <b>ipucu</b> ve <b>geri al</b> kapalƒ±dƒ±r.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ SONU√á EKRANI -->
<div class="overlay" id="endOverlay">
  <div class="overlayBox">
    <div class="endIcon" id="endIcon">üèÅ</div>
    <div class="bigTitle" id="endTitle">OYUN Bƒ∞TTƒ∞</div>
    <div class="subLine" id="endText"></div>
    <div class="row" style="justify-content:center;">
      <button id="endNewBtn">Yeni Oyun</button>
      <button id="endCloseBtn">Kapat</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
  runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYzorBVSTCcE3xzDZ9PyPprBdYEzKov3c",
  authDomain: "oyun-3bfba.firebaseapp.com",
  projectId: "oyun-3bfba"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= Yardƒ±mcƒ±lar ================= */
const $ = s => document.querySelector(s);
const setLoginMsg = t => $("#loginMsg").textContent = t;
const setLoginMsgMain = t => $("#loginMsgMain").textContent = t;
const setStatus = t => $("#status").textContent = t;

function profileOK(){
  const name = $("#name").value.trim();
  const classroom = $("#classroom").value.trim();
  if(!name || !classroom){
    setLoginMsgMain("Ad Soyad ve Sƒ±nƒ±f/≈ûube zorunlu.");
    return false;
  }
  setLoginMsgMain("");
  return true;
}

function openGameUI(){
  $("#loginCard").style.display = "none";
  $("#gameUI").style.display = "flex";
  hideEndOverlay();
}
function openLoginUI(){
  $("#loginCard").style.display = "block";
  $("#gameUI").style.display = "none";
  hideEndOverlay();
}

/* ================= Oda Kodu ================= */
function randInt(n){
  if (window.crypto && crypto.getRandomValues) {
    const a = new Uint32Array(1);
    crypto.getRandomValues(a);
    return a[0] % n;
  }
  return Math.floor(Math.random() * n);
}
function genRoomCode(){
  const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s = "";
  for(let i=0;i<6;i++) s += chars[randInt(chars.length)];
  return s;
}
function roomRef(code){ return doc(db, "rooms", code); }

/* ================= Sonu√ß Ekranƒ± ================= */
function hideEndOverlay(){
  $("#endOverlay").style.display = "none";
}
function showEndOverlay(winner){
  const mySide = (MODE==="ONLINE" ? ROLE : "W");
  const won = winner === mySide;
  $("#endOverlay").style.display = "flex";

  if(winner === "DRAW"){
    $("#endIcon").textContent = "ü§ù";
    $("#endTitle").textContent = "BERABERE";
    $("#endText").textContent = "Oyun bitti.";
    return;
  }

  if(won){
    $("#endIcon").textContent = "üèÜ";
    $("#endTitle").textContent = "KAZANDIN!";
    $("#endText").textContent = "Tebrikler üéâ";
    if(window.confetti){
      confetti({ particleCount: 240, spread: 120, origin: { y: 0.65 } });
      setTimeout(()=> confetti({ particleCount: 180, spread: 140, origin: { y: 0.55 } }), 200);
      setTimeout(()=> confetti({ particleCount: 140, spread: 160, origin: { y: 0.50 } }), 420);
    }
  }else{
    $("#endIcon").textContent = "üòî";
    $("#endTitle").textContent = "KAYBETTƒ∞N";
    $("#endText").textContent = "Tekrar dene ‚Äî bu sefer olacak.";
    if(window.confetti){
      confetti({ particleCount: 90, spread: 70, origin: { y: 0.20 } });
    }
  }
}

$("#endCloseBtn").addEventListener("click", hideEndOverlay);
$("#endNewBtn").addEventListener("click", ()=>{
  hideEndOverlay();
  newGame();
});

/* ================= Dokuz Ta≈ü Tahtasƒ± (24 nokta) ================= */
const POS = [
  [100,100],[500,100],[900,100],
  [250,250],[500,250],[750,250],
  [400,400],[500,400],[600,400],
  [100,500],[250,500],[400,500],[600,500],[750,500],[900,500],
  [400,600],[500,600],[600,600],
  [250,750],[500,750],[750,750],
  [100,900],[500,900],[900,900]
];

const ADJ = [
  [1,9],[0,2,4],[1,14],[4,10],[1,3,5,7],[4,13],[7,11],[4,6,8],[7,12],
  [0,10,21],[3,9,11,18],[6,10,15],[8,13,17],[5,12,14,20],[2,13,23],
  [11,16],[15,17,19],[12,16],[10,19],[16,18,20,22],[13,19],[9,22],[19,21,23],[14,22]
];

const MILLS = [
  [0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,13,14],[15,16,17],[18,19,20],[21,22,23],
  [0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],[5,13,20],[2,14,23]
];

const positionsG = document.getElementById("positions");

/* ================= Oyun Durumu ================= */
let MODE = null;         // "AI" | "ONLINE"
let ROLE = "W";          // Online: Host=W, Guest=B
let ROOM = null;
let unsubRoom = null;

let game = freshState();
let history = [];        // sadece AI i√ßin
let lastHumanMove = null;
let lastAIMove = null;
let lastBoardKeyB = null;

function freshState(){
  return {
    board: Array(24).fill(null),
    turn: "W",
    placed: {W:0, B:0},
    captureMode: false,
    pendingMover: null,
    winner: null,
    _temp: null
  };
}

function boardKey(board){
  return board.map(x=> x===null ? "." : x).join("");
}
function countOnBoard(board, p){ return board.filter(x=>x===p).length; }
function phaseOf(state, p){ return state.placed[p] < 9 ? "placing" : "moving"; }
function canFly(state, p){
  return phaseOf(state,p)==="moving" && countOnBoard(state.board,p) === 3;
}
function millsFormedBy(board, p, posIndex){
  return MILLS.filter(m => m.includes(posIndex) && m.every(i => board[i]===p));
}
function isInAnyMill(board, p, idx){
  return MILLS.some(m => m.includes(idx) && m.every(i => board[i]===p));
}
function removableOpponentStones(board, opponent){
  const oppIdx = board.map((v,i)=> v===opponent ? i : -1).filter(i=>i>=0);
  const notInMill = oppIdx.filter(i => !isInAnyMill(board, opponent, i));
  return notInMill.length ? notInMill : oppIdx;
}
function hasAnyLegalMove(state, p){
  const b = state.board;
  if(phaseOf(state,p)==="placing") return b.some(x=>x===null);
  const fly = canFly(state,p);
  const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);
  if(fly) return b.some(x=>x===null) && my.length>0;
  for(const from of my){
    if(ADJ[from].some(to => b[to]===null)) return true;
  }
  return false;
}
function checkWinner(state){
  if (state.placed.W < 9 || state.placed.B < 9) return null;
  const wCount = countOnBoard(state.board,'W');
  const bCount = countOnBoard(state.board,'B');

  if (wCount < 3 || !hasAnyLegalMove(state,'W')) return 'B';
  if (bCount < 3 || !hasAnyLegalMove(state,'B')) return 'W';
  return null;
}

function applyAction(state, p, action){
  const opp = p==='W' ? 'B' : 'W';
  const s = JSON.parse(JSON.stringify(state));
  const b = s.board;

  if(action.type==='place'){
    b[action.to] = p;
    s.placed[p] += 1;
  }else if(action.type==='move'){
    b[action.from] = null;
    b[action.to] = p;
  }else{
    throw new Error("Bilinmeyen hamle");
  }

  if(action.capture !== null && action.capture !== undefined){
    if(b[action.capture] === opp) b[action.capture] = null;
  }

  s.turn = opp;
  s.pendingMover = null;
  s.captureMode = false;
  s._temp = null;

  s.winner = checkWinner(s);
  return s;
}

/* === Online hamle doƒürulama (transaction i√ßinde) === */
function validateAction(state, p, action){
  const opp = p==='W' ? 'B' : 'W';
  const b = state.board;

  if(state.winner) throw new Error("Oyun bitti");
  if(state.turn !== p) throw new Error("Sƒ±ra sende deƒüil");

  // ta≈ü alma gerekiyorsa, action.capture zorunlu olabilir
  // biz action i√ßinde millMade bilgisi g√∂ndermiyoruz; server tarafƒ± yok; bu y√ºzden doƒürulamayƒ± burada tekrar yapƒ±yoruz

  const myPhase = phaseOf(state,p);

  if(action.type === "place"){
    if(myPhase !== "placing") throw new Error("Ta≈ü koyma bitti");
    if(action.from !== null && action.from !== undefined) throw new Error("Hatalƒ± hamle");
    if(action.to < 0 || action.to > 23) throw new Error("Hatalƒ± hedef");
    if(b[action.to] !== null) throw new Error("Dolu noktaya koyamazsƒ±n");

    // yerle≈ütir ve deƒüirmen kontrol et
    const b2 = b.slice(); b2[action.to] = p;
    const millMade = millsFormedBy(b2,p,action.to).length > 0;

    if(millMade){
      // capture zorunlu ve doƒüru hedeflerden olmalƒ±
      if(action.capture === null || action.capture === undefined) throw new Error("Ta≈ü alma gerekli");
      const removable = removableOpponentStones(b2, opp);
      if(b[action.capture] !== opp) throw new Error("Rakip ta≈üƒ± deƒüil");
      if(!removable.includes(action.capture)) throw new Error("Bu ta≈üƒ± alamazsƒ±n");
    }else{
      // deƒüirmen yoksa capture olmamalƒ±
      if(action.capture !== null && action.capture !== undefined) throw new Error("Ta≈ü alma yok");
    }
    return true;
  }

  if(action.type === "move"){
    if(myPhase !== "moving") throw new Error("√ñnce ta≈ülarƒ± dizmelisin");
    if(action.from < 0 || action.from > 23 || action.to < 0 || action.to > 23) throw new Error("Hatalƒ± hamle");
    if(b[action.from] !== p) throw new Error("Kendi ta≈üƒ±n deƒüil");
    if(b[action.to] !== null) throw new Error("Hedef dolu");

    const fly = canFly(state,p);
    if(!fly && !ADJ[action.from].includes(action.to)) throw new Error("Kom≈üu deƒüil");

    const b2 = b.slice();
    b2[action.from]=null; b2[action.to]=p;
    const millMade = millsFormedBy(b2,p,action.to).length > 0;

    if(millMade){
      if(action.capture === null || action.capture === undefined) throw new Error("Ta≈ü alma gerekli");
      const removable = removableOpponentStones(b2, opp);
      if(b[action.capture] !== opp) throw new Error("Rakip ta≈üƒ± deƒüil");
      if(!removable.includes(action.capture)) throw new Error("Bu ta≈üƒ± alamazsƒ±n");
    }else{
      if(action.capture !== null && action.capture !== undefined) throw new Error("Ta≈ü alma yok");
    }
    return true;
  }

  throw new Error("Ge√ßersiz hamle tipi");
}

/* ================= AI (Minimax) ================= */
function generateActions(state, p){
  const opp = p==='W' ? 'B' : 'W';
  const actions = [];
  const board = state.board;
  const phase = phaseOf(state,p);

  const addCaptureVariants = (boardAfter, moveObj) => {
    const millMade = moveObj.millMade;
    if(!millMade){
      actions.push({...moveObj, capture: null});
      return;
    }
    const removable = removableOpponentStones(boardAfter, opp);
    for(const cap of removable){
      actions.push({...moveObj, capture: cap});
    }
  };

  if(phase==="placing"){
    for(let to=0; to<24; to++){
      if(board[to]!==null) continue;
      const b2 = board.slice();
      b2[to]=p;
      const millMade = millsFormedBy(b2,p,to).length>0;
      addCaptureVariants(b2, {type:'place', from:null, to, millMade});
    }
    return actions;
  }

  const fly = canFly(state,p);
  const my = board.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);

  for(const from of my){
    const targets = fly
      ? board.map((v,i)=> v===null ? i : -1).filter(i=>i>=0)
      : ADJ[from].filter(to => board[to]===null);

    for(const to of targets){
      const b2 = board.slice();
      b2[from]=null; b2[to]=p;
      const millMade = millsFormedBy(b2,p,to).length>0;
      addCaptureVariants(b2, {type:'move', from, to, millMade});
    }
  }
  return actions;
}

function evalState(state){
  const b = state.board;
  const w = countOnBoard(b,'W');
  const bl = countOnBoard(b,'B');
  const material = (bl - w) * 100;

  const millsW = MILLS.filter(m => m.every(i => b[i]==='W')).length;
  const millsB = MILLS.filter(m => m.every(i => b[i]==='B')).length;
  const millsScore = (millsB - millsW) * 60;

  const pot = (p)=>{
    let c=0;
    for(const m of MILLS){
      const vals = m.map(i=>b[i]);
      const cntP = vals.filter(v=>v===p).length;
      const cntE = vals.filter(v=>v===null).length;
      if(cntP===2 && cntE===1) c++;
    }
    return c;
  };
  const potScore = (pot('B') - pot('W')) * 18;

  const mob = (p)=>{
    const ph = phaseOf(state,p);
    if(ph==="placing") return 0;
    const fly = canFly(state,p);
    if(fly) return b.filter(v=>v===null).length;
    let moves=0;
    for(let i=0;i<24;i++){
      if(b[i]!==p) continue;
      moves += ADJ[i].filter(j=>b[j]===null).length;
    }
    return moves;
  };
  const mobScore = (mob('B') - mob('W')) * 4;

  if(state.winner==='B') return 1e9;
  if(state.winner==='W') return -1e9;
  return material + millsScore + potScore + mobScore;
}

function minimax(state, depth, alpha, beta, maximizingForB){
  if(depth===0 || state.winner) return {score: evalState(state), action: null};

  const p = maximizingForB ? 'B' : 'W';
  const actions = generateActions(state, p);
  if(!actions.length) return {score: evalState(state), action: null};

  actions.sort((a,b)=>{
    const sa = (a.millMade?50:0) + (a.capture!=null?30:0);
    const sb = (b.millMade?50:0) + (b.capture!=null?30:0);
    return sb-sa;
  });

  let bestAction = null;

  if(maximizingForB){
    let best = -Infinity;
    for(const act of actions){
      const next = applyAction(state, 'B', act);
      const res = minimax(next, depth-1, alpha, beta, false);
      if(res.score > best){ best = res.score; bestAction = act; }
      alpha = Math.max(alpha, best);
      if(beta <= alpha) break;
    }
    return {score: best, action: bestAction};
  }else{
    let best = Infinity;
    for(const act of actions){
      const next = applyAction(state, 'W', act);
      const res = minimax(next, depth-1, alpha, beta, true);
      if(res.score < best){ best = res.score; bestAction = act; }
      beta = Math.min(beta, best);
      if(beta <= alpha) break;
    }
    return {score: best, action: bestAction};
  }
}

function isReverse(move, last){
  if(!last) return false;
  if(move.type!=="move") return false;
  return move.from === last.to && move.to === last.from;
}

function aiPickAction(){
  const phase = phaseOf(game,'B');
  const depth = phase==="placing" ? 3 : 4;

  // yerle≈ütirmede rastgelelik
  if(phase==="placing"){
    const actions = generateActions(game,'B');
    const scored = actions.map(a=>{
      const s2 = applyAction(game,'B',a);
      return {a, score: evalState(s2)};
    }).sort((x,y)=> y.score - x.score);

    const topN = scored.slice(0, Math.min(6, scored.length)).map(x=>x.a);
    return topN[randInt(topN.length)];
  }

  let {action} = minimax(game, depth, -Infinity, Infinity, true);
  if(!action) return null;

  // geri hamleyi azalt
  if(isReverse(action, lastAIMove)){
    const alts = generateActions(game,'B')
      .filter(a => !(a.type==='move' && isReverse(a, lastAIMove)))
      .slice(0, 10);
    if(alts.length) action = alts[randInt(alts.length)];
  }

  // basit d√∂ng√º azaltma
  const sTry = applyAction(game,'B',action);
  const keyTry = boardKey(sTry.board);
  if(lastBoardKeyB && keyTry === lastBoardKeyB){
    const alts2 = generateActions(game,'B').slice(0, 12);
    if(alts2.length) action = alts2[randInt(alts2.length)];
  }

  return action;
}

function aiMove(){
  if(MODE!=="AI") return;
  if(game.winner) return;
  if(game.turn!=='B') return;

  setStatus("AI d√º≈ü√ºn√ºyor...");
  setTimeout(()=>{
    const action = aiPickAction();
    if(!action){
      game.winner = checkWinner(game) || 'W';
      render();
      setStatus("Oyun bitti.");
      showEndOverlay(game.winner);
      return;
    }

    const beforeKey = boardKey(game.board);
    game = applyAction(game, 'B', action);
    pushHistory();
    render();

    if(action.type === 'move') lastAIMove = {type:'move', from: action.from, to: action.to};
    else lastAIMove = null;

    lastBoardKeyB = beforeKey;

    if(game.winner){
      setStatus("Oyun bitti.");
      showEndOverlay(game.winner);
    }else{
      setStatus(action.millMade ? "AI deƒüirmen yaptƒ± ve 1 ta≈üƒ±nƒ± aldƒ±. Sƒ±ra sende." : "AI hamle yaptƒ±. Sƒ±ra sende.");
    }
  }, 140);
}

/* ================= UI √áizim ================= */
function pushHistory(){
  history.push(JSON.parse(JSON.stringify(game)));
  $("#undoBtn").disabled = history.length <= 1;
}

function updateKPI(){
  $("#wOnBoard").textContent = countOnBoard(game.board,'W');
  $("#bOnBoard").textContent = countOnBoard(game.board,'B');
  $("#wPlaced").textContent = game.placed.W;
  $("#bPlaced").textContent = game.placed.B;

  const phase = (game.placed.W<9 || game.placed.B<9) ? "Ta≈ü koyma" : "Hareket";
  $("#phasePill").textContent = "A≈üama: " + phase;

  $("#modePill").textContent = "Mod: " + (MODE==="AI" ? "Bilgisayar" : "Online");
  if(MODE==="AI"){
    $("#youPill").textContent = "Sen: Turuncu (W)";
    $("#roomPill").style.display = "none";
  }else{
    $("#youPill").textContent = ROLE==="W" ? "Sen: Turuncu (Host)" : "Sen: Lacivert (Guest)";
    $("#roomPill").style.display = "inline-block";
    $("#roomPill").textContent = "Oda: " + ROOM;
  }
}

function render(){
  positionsG.innerHTML = "";
  for(let i=0;i<24;i++){
    const [x,y] = POS[i];
    const v = game.board[i];

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", x); c.setAttribute("cy", y);
    c.setAttribute("r", 26);
    c.classList.add("pos");
    if(v===null) c.classList.add("empty");
    if(game.pendingMover===i) c.classList.add("sel","glow");
    c.addEventListener("click", ()=> onClickPos(i));
    g.appendChild(c);

    if(v!==null){
      const s = document.createElementNS("http://www.w3.org/2000/svg","circle");
      s.setAttribute("cx", x); s.setAttribute("cy", y);
      s.setAttribute("r", 18);
      s.classList.add(v==='W' ? "stoneW" : "stoneB");
      s.classList.add("glow");
      g.appendChild(s);
    }

    positionsG.appendChild(g);
  }

  updateKPI();

  const isMyTurn = (MODE==="AI") ? (game.turn==="W") : (game.turn===ROLE);
  $("#hintBtn").disabled = !!game.winner || !isMyTurn || MODE==="ONLINE";
  $("#undoBtn").disabled = MODE==="ONLINE" ? true : (history.length <= 1);
}

/* ================= Hamle Akƒ±≈üƒ± ================= */
async function submitOnlineAction(action){
  try{
    await runTransaction(db, async (tx)=>{
      const ref = roomRef(ROOM);
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error("Oda yok");

      const data = snap.data();
      const state = data.state;
      validateAction(state, ROLE, action);

      const next = applyAction(state, ROLE, action);
      tx.update(ref, { state: next, updatedAt: serverTimestamp(), status: next.winner ? "ended" : "playing" });
    });
  }catch(e){
    setStatus("Hamle olmadƒ±: " + (e?.message || e));
  }
}

function humanApplyAI(action){
  // AI modunda aynƒ± hamleyi anƒ±nda geri alma engeli (move i√ßin)
  if(action.type==="move" && isReverse(action, lastHumanMove)){
    setStatus("Aynƒ± hamleyi hemen geri alamazsƒ±n. Farklƒ± bir hamle dene.");
    return;
  }

  game = applyAction(game, "W", action);
  if(action.type==="move") lastHumanMove = {type:"move", from: action.from, to: action.to};
  else lastHumanMove = null;

  pushHistory();
  render();

  if(game.winner){
    setStatus("Oyun bitti.");
    showEndOverlay(game.winner);
    return;
  }

  if(game.placed.W>=9 && game.placed.B>=9){
    setStatus("Ta≈ü koyma bitti. Artƒ±k ta≈ülarƒ±nƒ± hareket ettirebilirsin.");
  }else{
    setStatus("Sƒ±ra AI‚Äôda.");
  }

  aiMove();
}

async function humanAction(action){
  if(MODE==="AI"){
    humanApplyAI(action);
    return;
  }
  await submitOnlineAction(action);
}

/* ======= Kullanƒ±cƒ± tƒ±klama mantƒ±ƒüƒ± (AI + Online ortak) ======= */
function onClickPos(i){
  if(game.winner) return;

  const me = (MODE==="AI") ? "W" : ROLE;
  const opp = me==="W" ? "B" : "W";

  // Online‚Äôda sƒ±ra sende deƒüilse tƒ±klama yok
  if(MODE==="ONLINE" && game.turn !== ROLE) return;
  if(MODE==="AI" && game.turn !== "W") return;

  const b = game.board;
  const myPhase = phaseOf(game, me);

  // ‚úÖ TA≈û ALMA MODU (deƒüirmen sonrasƒ±)
  if(game.captureMode && game._temp){
    const { removable, pendingAction } = game._temp;
    if(b[i] !== opp) return;
    if(!removable.includes(i)) return;

    const action = {...pendingAction, capture: i};
    game.captureMode = false;
    game._temp = null;
    humanAction(action);
    return;
  }

  // ‚úÖ TA≈û KOYMA
  if(myPhase === "placing"){
    if(b[i] !== null) return;

    const b2 = b.slice(); b2[i]=me;
    const millMade = millsFormedBy(b2, me, i).length > 0;

    if(!millMade){
      humanAction({type:"place", from:null, to:i, capture:null});
      return;
    }

    const removable = removableOpponentStones(b2, opp);
    setStatus("Deƒüirmen yaptƒ±n! Rakibin bir ta≈üƒ±na dokun (m√ºmk√ºnse deƒüirmende olmayan).");
    game.captureMode = true;
    game._temp = {
      removable,
      pendingAction: {type:"place", from:null, to:i}
    };
    render();
    return;
  }

  // ‚úÖ HAREKET A≈ûAMASI: ta≈ü se√ß
  if(b[i] === me){
    game.pendingMover = (game.pendingMover===i ? null : i);
    render();
    if(game.pendingMover!==null){
      const fly = canFly(game, me);
      setStatus(fly ? "Ta≈ü se√ßildi. U√ßma var: herhangi bir bo≈ü noktaya dokun." : "Ta≈ü se√ßildi. Kom≈üu bo≈ü noktaya dokun.");
    }else{
      setStatus("Sƒ±ra sende.");
    }
    return;
  }

  // ‚úÖ HAREKET/U√áMA hedef se√ß
  if(b[i]===null && game.pendingMover!==null){
    const from = game.pendingMover;
    const fly = canFly(game, me);
    if(!fly && !ADJ[from].includes(i)) return;

    const b2 = b.slice();
    b2[from]=null; b2[i]=me;
    const millMade = millsFormedBy(b2, me, i).length > 0;

    game.pendingMover = null;

    if(!millMade){
      humanAction({type:"move", from, to:i, capture:null});
      return;
    }

    const removable = removableOpponentStones(b2, opp);
    setStatus("Deƒüirmen yaptƒ±n! Rakibin bir ta≈üƒ±na dokun.");
    game.captureMode = true;
    game._temp = {
      removable,
      pendingAction: {type:"move", from, to:i}
    };
    render();
    return;
  }
}

/* ================= ƒ∞pucu / Geri Al ================= */
function undo(){
  if(MODE!=="AI") return;
  if(history.length <= 1) return;
  history.pop();
  game = JSON.parse(JSON.stringify(history[history.length-1]));
  lastHumanMove = null;
  lastAIMove = null;
  lastBoardKeyB = null;
  render();
  setStatus("Geri alƒ±ndƒ±. Sƒ±ra sende.");
}

function hint(){
  if(MODE!=="AI") return;
  if(game.turn!=="W" || game.winner) return;
  const depth = phaseOf(game,'W')==="placing" ? 3 : 4;
  const {action} = minimax(game, depth, -Infinity, Infinity, false);
  if(!action){ setStatus("ƒ∞pucu bulunamadƒ±."); return; }
  const msg = action.type==='place'
    ? `ƒ∞pucu: #${action.to+1} noktasƒ±na ta≈ü koy.`
    : `ƒ∞pucu: #${action.from+1} ‚Üí #${action.to+1}.`;
  setStatus(msg);
}

/* ================= Yeni Oyun ================= */
async function newGame(){
  hideEndOverlay();

  if(MODE==="AI"){
    game = freshState();
    history = [];
    lastHumanMove = null;
    lastAIMove = null;
    lastBoardKeyB = null;
    pushHistory();
    render();
    setStatus("Sƒ±ra sende. Bo≈ü bir noktaya ta≈ü koy.");
    return;
  }

  // Online‚Äôda sadece Host yeni oyun ba≈ülatƒ±r
  if(ROLE !== "W"){
    setStatus("Online‚Äôda yeni oyunu sadece Host (Turuncu) ba≈ülatabilir.");
    return;
  }

  try{
    await updateDoc(roomRef(ROOM), {
      state: freshState(),
      updatedAt: serverTimestamp(),
      status: "playing"
    });
    setStatus("Yeni oyun ba≈ülatƒ±ldƒ±.");
  }catch(e){
    setStatus("Yeni oyun hatasƒ±: " + (e?.message || e));
  }
}

/* ================= Online Oda Akƒ±≈üƒ± ================= */
async function createRoom(){
  if(!profileOK()) return;
  MODE = "ONLINE";
  ROLE = "W";
  ROOM = genRoomCode();

  const name = $("#name").value.trim();
  const classroom = $("#classroom").value.trim();

  try{
    await setDoc(roomRef(ROOM), {
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      status: "waiting",
      host: { name, classroom },
      guest: null,
      state: freshState()
    });

    setLoginMsg("Oda olu≈üturuldu.\nKOD: " + ROOM + "\nRakibe bu kodu g√∂nder.");
    openGameUI();
    setStatus("Rakip kodla girince ba≈ülayabilirsiniz.\nOda: " + ROOM);
    startRoomListener();
    render();
  }catch(e){
    setLoginMsg("ODA OLU≈ûTURMA HATASI:\n" + (e?.message || e));
  }
}

async function joinRoom(){
  if(!profileOK()) return;
  MODE = "ONLINE";
  ROLE = "B";
  ROOM = ($("#roomCode").value || "").trim().toUpperCase();
  if(!ROOM){
    setLoginMsg("Oda kodu gir.");
    return;
  }

  const name = $("#name").value.trim();
  const classroom = $("#classroom").value.trim();

  try{
    const snap = await getDoc(roomRef(ROOM));
    if(!snap.exists()){
      setLoginMsg("ODA BULUNAMADI. Kodu kontrol et.");
      return;
    }

    await runTransaction(db, async (tx)=>{
      const ref = roomRef(ROOM);
      const s = await tx.get(ref);
      if(!s.exists()) throw new Error("Oda yok");
      const d = s.data();
      if(d.guest) throw new Error("Oda dolu");
      tx.update(ref, {
        guest: { name, classroom },
        status: "playing",
        updatedAt: serverTimestamp()
      });
    });

    openGameUI();
    setStatus("Odaya katƒ±ldƒ±n.\nSƒ±ra Turuncu ile ba≈ülar.\nOda: " + ROOM);
    startRoomListener();
    render();
  }catch(e){
    setLoginMsg("KATILMA HATASI:\n" + (e?.message || e));
  }
}

function startRoomListener(){
  if(unsubRoom) unsubRoom();
  unsubRoom = onSnapshot(roomRef(ROOM), (snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();
    if(data?.state){
      game = data.state;
      render();
      if(game.winner){
        showEndOverlay(game.winner);
        setStatus("Oyun bitti.");
      }else{
        const myTurn = (game.turn === ROLE);
        if(myTurn) setStatus("Sƒ±ra sende.");
        else setStatus("Rakip oynuyor...");
      }
    }
  });
}

/* ================= UI Butonlarƒ± ================= */
$("#toggleOnline").addEventListener("click", ()=>{
  const p = $("#onlinePanel");
  p.style.display = (p.style.display === "none" ? "block" : "none");
});

$("#startAI").addEventListener("click", ()=>{
  if(!profileOK()) return;
  MODE = "AI";
  ROLE = "W";
  ROOM = null;
  if(unsubRoom){ unsubRoom(); unsubRoom=null; }

  openGameUI();
  game = freshState();
  history = [];
  pushHistory();
  render();
  setStatus("Sƒ±ra sende. Bo≈ü bir noktaya ta≈ü koy.");
});

$("#createRoom").addEventListener("click", createRoom);
$("#joinRoomBtn").addEventListener("click", joinRoom);

$("#newBtn").addEventListener("click", newGame);
$("#undoBtn").addEventListener("click", undo);
$("#hintBtn").addEventListener("click", hint);

$("#leaveBtn").addEventListener("click", ()=>{
  if(unsubRoom){ unsubRoom(); unsubRoom=null; }
  MODE = null; ROLE = "W"; ROOM = null;
  game = freshState();
  history = [];
  setLoginMsg(""); setLoginMsgMain("");
  openLoginUI();
});

/* ================= ƒ∞lk A√ßƒ±lƒ±≈ü ================= */
game = freshState();
render();
setLoginMsgMain("Mod se√ßip ba≈ülayabilirsin.");
</script>
</body>
</html>
