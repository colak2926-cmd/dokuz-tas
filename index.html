<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokuz Ta≈ü | Resm√Æ (AI + Online)</title>
  <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{--bg:#0b1020;--panel:#121a33;--line:#93a4ff55;--text:#e9edff;--muted:#b9c2ff;--b:#2a3570}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1120px;margin:0 auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .top{display:flex;flex-wrap:wrap;gap:12px;align-items:stretch}
    .card{background:var(--panel);border:1px solid var(--b);border-radius:14px;padding:12px}
    .boardCard{flex:1 1 580px;display:flex;align-items:center;justify-content:center}
    .infoCard{flex:1 1 360px;min-width:320px}
    h1{font-size:18px;margin:0 0 8px 0;font-weight:1000}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{border:1px solid var(--b);background:#0f1630;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900}
    button:hover{border-color:#4052b6}
    button:disabled{opacity:.55;cursor:not-allowed}
    input{width:100%;box-sizing:border-box;border:1px solid var(--b);background:#0f1630;color:var(--text);padding:12px;border-radius:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1630;border:1px solid var(--b);color:var(--muted);font-size:12px}
    .status{margin-top:10px;line-height:1.35;color:var(--muted);min-height:52px;white-space:pre-line}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .kpi div{background:#0f1630;border:1px solid var(--b);border-radius:12px;padding:10px;font-size:13px;color:var(--muted)}
    .kpi b{color:var(--text)}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:#24306a;margin:10px 0}

    svg{width:min(90vw,640px);height:auto}
    .line{stroke:var(--line);stroke-width:8;stroke-linecap:round}
    .pos{fill:#0f1630;stroke:var(--b);stroke-width:3}
    .pos.empty{cursor:pointer}
    .pos:hover{stroke:#6e84ff}
    .stoneW{fill:#f59e0b;stroke:#ffd08a;stroke-width:3}
    .stoneB{fill:#0b3a8a;stroke:#7aa2ff;stroke-width:3}
    .stoneW,.stoneB{pointer-events:none}
    .sel{stroke:#ffd166;stroke-width:5}
    .glow{filter:url(#glow)}

    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:99999}
    .overlayBox{width:min(94vw,720px);border-radius:26px;padding:26px;border:2px solid #4052b6;background:#121a33;text-align:center;box-shadow:0 20px 80px rgba(0,0,0,.6)}
    .bigTitle{font-size:clamp(40px,8vw,86px);font-weight:1000;letter-spacing:1px;margin:0 0 10px 0;text-transform:uppercase}
    .subLine{font-size:clamp(16px,2.8vw,22px);color:#c9d0ff;margin:0 0 18px 0;line-height:1.4}
    .endIcon{font-size:64px;margin-bottom:8px}
  </style>
</head>

<body>
<div class="wrap">

  <!-- Gƒ∞Rƒ∞≈û -->
  <div class="card" id="loginCard">
    <h1>Dokuz Ta≈ü ‚Äì Giri≈ü</h1>
    <div class="small">AI veya Online Oda se√ßebilirsin. Online‚Äôda Host=Turuncu, Guest=Lacivert.</div>
    <div style="height:10px"></div>

    <label class="small">Ad Soyad</label>
    <input id="name" placeholder="√ñrn: Ay≈üe Yƒ±lmaz" autocomplete="name"/>
    <div style="height:10px"></div>

    <label class="small">Sƒ±nƒ±f / ≈ûube</label>
    <input id="classroom" placeholder="√ñrn: 5/A"/>
    <div style="height:12px"></div>

    <div class="row">
      <button id="startAI">Bilgisayara Kar≈üƒ± (AI)</button>
      <button id="toggleOnline">Online Rakip</button>
    </div>

    <div id="onlinePanel" style="display:none; margin-top:12px;">
      <div class="divider"></div>
      <div class="row">
        <button id="createRoom">Oda Olu≈ütur</button>
        <button id="joinRoomBtn">Koda Katƒ±l</button>
      </div>
      <div style="height:10px"></div>
      <label class="small">Oda Kodu</label>
      <input id="roomCode" placeholder="√ñrn: AB12CD" style="text-transform:uppercase"/>
      <div class="status" id="loginMsg"></div>
    </div>

    <div class="status" id="loginMsgMain"></div>
  </div>

  <!-- OYUN -->
  <div class="top" id="gameUI" style="display:none">
    <div class="card boardCard">
      <svg viewBox="0 0 1000 1000" aria-label="Dokuz ta≈ü tahtasƒ±">
        <defs>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>

        <rect x="100" y="100" width="800" height="800" fill="none" class="line"/>
        <rect x="250" y="250" width="500" height="500" fill="none" class="line"/>
        <rect x="400" y="400" width="200" height="200" fill="none" class="line"/>

        <line x1="500" y1="100" x2="500" y2="400" class="line"/>
        <line x1="500" y1="600" x2="500" y2="900" class="line"/>
        <line x1="100" y1="500" x2="400" y2="500" class="line"/>
        <line x1="600" y1="500" x2="900" y2="500" class="line"/>

        <g id="positions"></g>
      </svg>
    </div>

    <div class="card infoCard">
      <h1>Durum Paneli</h1>

      <div class="row" style="margin-bottom:6px;">
        <span class="pill" id="modePill">Mod: -</span>
        <span class="pill" id="youPill">Sen: -</span>
        <span class="pill" id="roomPill" style="display:none;">Oda: -</span>
      </div>

      <div class="row">
        <span class="pill">Turuncu (W)</span>
        <span class="pill">Lacivert (B)</span>
        <span class="pill" id="phasePill">A≈üama: Ta≈ü koyma</span>
      </div>

      <div class="kpi">
        <div>Turuncu: Tahtada <b id="wOnBoard">0</b> / Yerle≈üen <b id="wPlaced">0</b></div>
        <div>Lacivert: Tahtada <b id="bOnBoard">0</b> / Yerle≈üen <b id="bPlaced">0</b></div>
      </div>

      <div class="status" id="status"></div>

      <div class="row" style="margin-top:10px;">
        <button id="newBtn">Yeni Oyun</button>
        <button id="undoBtn">Geri Al</button>
        <button id="hintBtn">ƒ∞pucu</button>
        <button id="leaveBtn">√áƒ±k</button>
      </div>

      <div class="divider"></div>

      <div class="small">
        Online‚Äôda <b>geri al</b> ve <b>ipucu</b> kapalƒ±dƒ±r.<br/>
        Deƒüirmen olursa √∂nce hamle tahtaya d√º≈üer, sonra ‚ÄúTa≈ü al‚Äù a≈üamasƒ± ba≈ülar.
      </div>
    </div>
  </div>
</div>

<!-- SONU√á -->
<div class="overlay" id="endOverlay">
  <div class="overlayBox">
    <div class="endIcon" id="endIcon">üèÅ</div>
    <div class="bigTitle" id="endTitle">OYUN Bƒ∞TTƒ∞</div>
    <div class="subLine" id="endText"></div>
    <div class="row" style="justify-content:center;">
      <button id="endNewBtn">Yeni Oyun</button>
      <button id="endCloseBtn">Kapat</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
  runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYzorBVSTCcE3xzDZ9PyPprBdYEzKov3c",
  authDomain: "oyun-3bfba.firebaseapp.com",
  projectId: "oyun-3bfba"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= Helpers ================= */
const $ = s => document.querySelector(s);
const setLoginMsg = t => $("#loginMsg").textContent = t;
const setLoginMsgMain = t => $("#loginMsgMain").textContent = t;
const setStatus = t => $("#status").textContent = t;

function profileOK(){
  const name = $("#name").value.trim();
  const classroom = $("#classroom").value.trim();
  if(!name || !classroom){
    setLoginMsgMain("Ad Soyad ve Sƒ±nƒ±f/≈ûube zorunlu.");
    return false;
  }
  setLoginMsgMain("");
  return true;
}

function openGameUI(){
  $("#loginCard").style.display = "none";
  $("#gameUI").style.display = "flex";
  hideEndOverlay();
}
function openLoginUI(){
  $("#loginCard").style.display = "block";
  $("#gameUI").style.display = "none";
  hideEndOverlay();
}

/* ================= Overlay ================= */
function hideEndOverlay(){ $("#endOverlay").style.display = "none"; }
function showEndOverlay(winner){
  const mySide = (MODE==="ONLINE" ? ROLE : "W");
  $("#endOverlay").style.display = "flex";

  if(winner==="DRAW"){
    $("#endIcon").textContent="ü§ù";
    $("#endTitle").textContent="BERABERE";
    $("#endText").textContent="Oyun bitti.";
    return;
  }

  const won = (winner === mySide);
  if(won){
    $("#endIcon").textContent="üèÜ";
    $("#endTitle").textContent="KAZANDIN!";
    $("#endText").textContent="Tebrikler üéâ";
    if(window.confetti){
      confetti({ particleCount: 240, spread: 120, origin: { y: 0.65 } });
      setTimeout(()=> confetti({ particleCount: 180, spread: 140, origin: { y: 0.55 } }), 200);
      setTimeout(()=> confetti({ particleCount: 140, spread: 160, origin: { y: 0.50 } }), 420);
    }
  }else{
    $("#endIcon").textContent="üòî";
    $("#endTitle").textContent="KAYBETTƒ∞N";
    $("#endText").textContent="Tekrar dene ‚Äî bu sefer olacak.";
  }
}
$("#endCloseBtn").addEventListener("click", hideEndOverlay);
$("#endNewBtn").addEventListener("click", ()=>{ hideEndOverlay(); newGame(); });

/* ================= Board Data (24 point) ================= */
const POS = [
  [100,100],[500,100],[900,100],
  [250,250],[500,250],[750,250],
  [400,400],[500,400],[600,400],
  [100,500],[250,500],[400,500],[600,500],[750,500],[900,500],
  [400,600],[500,600],[600,600],
  [250,750],[500,750],[750,750],
  [100,900],[500,900],[900,900]
];

const ADJ = [
  [1,9],[0,2,4],[1,14],[4,10],[1,3,5,7],[4,13],[7,11],[4,6,8],[7,12],
  [0,10,21],[3,9,11,18],[6,10,15],[8,13,17],[5,12,14,20],[2,13,23],
  [11,16],[15,17,19],[12,16],[10,19],[16,18,20,22],[13,19],[9,22],[19,21,23],[14,22]
];

const MILLS = [
  [0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,13,14],[15,16,17],[18,19,20],[21,22,23],
  [0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],[5,13,20],[2,14,23]
];

const positionsG = document.getElementById("positions");

/* ================= Game State ================= */
let MODE = null;           // "AI" | "ONLINE"
let ROLE = "W";            // Online: Host=W, Guest=B
let ROOM = null;
let unsubRoom = null;

let game = freshState();
let history = [];          // only AI
let lastHumanMove = null;  // for immediate reverse prevention (AI mode)

function freshState(){
  return {
    board: Array(24).fill(null),
    turn: "W",
    placed: {W:0, B:0},
    pendingMover: null,
    // capture step (SYNC): { by:"W"|"B", removable:[...]}
    capture: null,
    winner: null
  };
}

function countOnBoard(board,p){ return board.filter(x=>x===p).length; }
function phaseOf(state,p){ return state.placed[p] < 9 ? "placing" : "moving"; }
function canFly(state,p){ return phaseOf(state,p)==="moving" && countOnBoard(state.board,p) === 3; }

function millsFormedBy(board,p,posIndex){
  return MILLS.filter(m => m.includes(posIndex) && m.every(i => board[i]===p));
}
function isInAnyMill(board,p,idx){
  return MILLS.some(m => m.includes(idx) && m.every(i => board[i]===p));
}
function removableOpponentStones(board,opponent){
  const oppIdx = board.map((v,i)=> v===opponent ? i : -1).filter(i=>i>=0);
  const notInMill = oppIdx.filter(i => !isInAnyMill(board, opponent, i));
  return notInMill.length ? notInMill : oppIdx;
}
function hasAnyLegalMove(state,p){
  const b = state.board;
  if(phaseOf(state,p)==="placing") return b.some(x=>x===null);
  const fly = canFly(state,p);
  const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);
  if(fly) return b.some(x=>x===null) && my.length>0;
  for(const from of my){
    if(ADJ[from].some(to => b[to]===null)) return true;
  }
  return false;
}
function checkWinner(state){
  // winner only after both placed 9
  if(state.placed.W < 9 || state.placed.B < 9) return null;
  const w = countOnBoard(state.board,'W');
  const b = countOnBoard(state.board,'B');
  if(w < 3 || !hasAnyLegalMove(state,'W')) return "B";
  if(b < 3 || !hasAnyLegalMove(state,'B')) return "W";
  return null;
}

/* ================= Apply Actions =================
   action types:
   - place {type:"place", to}
   - move  {type:"move", from, to}
   - capture {type:"capture", at}
*/
function applyAction(state, p, action){
  const opp = (p==="W") ? "B" : "W";
  const s = JSON.parse(JSON.stringify(state));
  const b = s.board;

  if(s.winner) return s;

  // If capture phase exists, only capture allowed by that player
  if(s.capture){
    if(action.type !== "capture") throw new Error("Ta≈ü almalƒ±sƒ±n");
    if(s.capture.by !== p) throw new Error("Ta≈üƒ± sen alamazsƒ±n");
    if(b[action.at] !== opp) throw new Error("Rakip ta≈üƒ± deƒüil");
    if(!s.capture.removable.includes(action.at)) throw new Error("Bu ta≈üƒ± alamazsƒ±n");
    b[action.at] = null;
    s.capture = null;
    // after capture, turn switches
    s.turn = opp;
    s.winner = checkWinner(s);
    return s;
  }

  const myPhase = phaseOf(s,p);

  if(action.type==="place"){
    if(myPhase!=="placing") throw new Error("Ta≈ü koyma bitti");
    if(b[action.to]!==null) throw new Error("Dolu");
    b[action.to]=p;
    s.placed[p]+=1;

    const millMade = millsFormedBy(b,p,action.to).length>0;
    if(millMade){
      s.capture = { by: p, removable: removableOpponentStones(b, opp) };
      // turn stays the same until capture
      s.turn = p;
    }else{
      s.turn = opp;
    }
    s.winner = checkWinner(s);
    return s;
  }

  if(action.type==="move"){
    if(myPhase!=="moving") throw new Error("√ñnce ta≈ülarƒ± dizmelisin");
    if(b[action.from]!==p) throw new Error("Kendi ta≈üƒ±n deƒüil");
    if(b[action.to]!==null) throw new Error("Hedef dolu");

    const fly = canFly(s,p);
    if(!fly && !ADJ[action.from].includes(action.to)) throw new Error("Kom≈üu deƒüil");

    b[action.from]=null;
    b[action.to]=p;

    const millMade = millsFormedBy(b,p,action.to).length>0;
    if(millMade){
      s.capture = { by: p, removable: removableOpponentStones(b, opp) };
      s.turn = p; // capture first
    }else{
      s.turn = opp;
    }
    s.winner = checkWinner(s);
    return s;
  }

  throw new Error("Ge√ßersiz hamle");
}

/* ================= UI ================= */
function pushHistory(){
  history.push(JSON.parse(JSON.stringify(game)));
  $("#undoBtn").disabled = (history.length<=1);
}
function updateKPI(){
  $("#wOnBoard").textContent = countOnBoard(game.board,"W");
  $("#bOnBoard").textContent = countOnBoard(game.board,"B");
  $("#wPlaced").textContent = game.placed.W;
  $("#bPlaced").textContent = game.placed.B;

  const phase = (game.placed.W<9 || game.placed.B<9) ? "Ta≈ü koyma" : "Hareket";
  $("#phasePill").textContent = "A≈üama: " + phase;

  $("#modePill").textContent = "Mod: " + (MODE==="AI" ? "Bilgisayar" : "Online");
  if(MODE==="AI"){
    $("#youPill").textContent = "Sen: Turuncu (W)";
    $("#roomPill").style.display="none";
  }else{
    $("#youPill").textContent = (ROLE==="W" ? "Sen: Turuncu (Host)" : "Sen: Lacivert (Guest)");
    $("#roomPill").style.display="inline-block";
    $("#roomPill").textContent = "Oda: " + ROOM;
  }
}
function render(){
  positionsG.innerHTML = "";
  for(let i=0;i<24;i++){
    const [x,y]=POS[i];
    const v=game.board[i];

    const g=document.createElementNS("http://www.w3.org/2000/svg","g");

    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",26);
    c.classList.add("pos");
    if(v===null) c.classList.add("empty");
    if(game.pendingMover===i) c.classList.add("sel","glow");
    c.addEventListener("click", ()=> onClickPos(i));
    g.appendChild(c);

    if(v!==null){
      const s=document.createElementNS("http://www.w3.org/2000/svg","circle");
      s.setAttribute("cx",x); s.setAttribute("cy",y); s.setAttribute("r",18);
      s.classList.add(v==="W" ? "stoneW" : "stoneB");
      s.classList.add("glow");
      g.appendChild(s);
    }
    positionsG.appendChild(g);
  }

  updateKPI();

  const isMyTurn = (MODE==="AI") ? (game.turn==="W") : (game.turn===ROLE);
  const captureTurn = game.capture ? (game.capture.by === ((MODE==="AI") ? "W" : ROLE)) : false;

  // if capture required, it's still your "turn" but only capture clicks should work
  const allowActions = !!game.winner ? false : (isMyTurn || captureTurn);

  $("#hintBtn").disabled = (MODE!=="AI") || !allowActions || !!game.winner;
  $("#undoBtn").disabled = (MODE!=="AI") || (history.length<=1);
}

function setTurnText(){
  if(game.winner){
    setStatus("Oyun bitti.");
    return;
  }
  if(game.capture){
    const who = (game.capture.by==="W") ? "Turuncu" : "Lacivert";
    setStatus(`${who} deƒüirmen yaptƒ±. 1 ta≈ü alƒ±nmalƒ±.`);
    return;
  }
  const whoTurn = (game.turn==="W") ? "Turuncu" : "Lacivert";
  const mine = (MODE==="AI") ? "Turuncu" : (ROLE==="W" ? "Turuncu" : "Lacivert");
  if(MODE==="AI"){
    setStatus(game.turn==="W" ? "Sƒ±ra sende." : "AI oynuyor...");
  }else{
    setStatus(`${whoTurn} sƒ±rasƒ±. (Sen: ${mine})`);
  }
}

/* ================= Click Logic ================= */
function onClickPos(i){
  if(game.winner) return;

  const me = (MODE==="AI") ? "W" : ROLE;
  const opp = (me==="W") ? "B" : "W";

  // Online: turn/capture gate
  if(MODE==="ONLINE"){
    const isMyCapture = game.capture && game.capture.by===ROLE;
    const isMyTurn = (game.turn===ROLE);
    if(!isMyCapture && !isMyTurn) return;
  }else{
    // AI: only when W's turn or capture for W
    const isMyCapture = game.capture && game.capture.by==="W";
    if(!isMyCapture && game.turn!=="W") return;
  }

  const b = game.board;

  // CAPTURE STEP
  if(game.capture){
    if(game.capture.by !== me) return;
    if(b[i] !== opp) return;
    if(!game.capture.removable.includes(i)) return;
    doAction({type:"capture", at:i});
    return;
  }

  const myPhase = phaseOf(game, me);

  // PLACING
  if(myPhase==="placing"){
    if(b[i]!==null) return;
    doAction({type:"place", to:i});
    return;
  }

  // MOVING
  if(b[i]===me){
    game.pendingMover = (game.pendingMover===i ? null : i);
    render();
    if(game.pendingMover!==null){
      const fly = canFly(game, me);
      setStatus(fly ? "Ta≈ü se√ßildi. U√ßma var: herhangi bir bo≈ü noktaya dokun." : "Ta≈ü se√ßildi. Kom≈üu bo≈ü noktaya dokun.");
    }else{
      setTurnText();
    }
    return;
  }

  if(b[i]===null && game.pendingMover!==null){
    const from = game.pendingMover;
    const fly = canFly(game, me);
    if(!fly && !ADJ[from].includes(i)) return;

    // immediate reverse prevention (AI mode only)
    if(MODE==="AI" && lastHumanMove && lastHumanMove.from===i && lastHumanMove.to===from){
      setStatus("Aynƒ± hamleyi hemen geri alamazsƒ±n. Farklƒ± hamle dene.");
      return;
    }

    game.pendingMover = null;
    doAction({type:"move", from, to:i});
    return;
  }
}

function endIfWinner(){
  if(game.winner){
    showEndOverlay(game.winner);
  }
}

/* ================= Online Sync ================= */
function roomRef(code){ return doc(db,"rooms",code); }

async function submitOnlineAction(action){
  try{
    await runTransaction(db, async (tx)=>{
      const ref = roomRef(ROOM);
      const snap = await tx.get(ref);
      if(!snap.exists()) throw new Error("Oda yok");
      const data = snap.data();
      const st = data.state;

      // validate who can act
      if(st.winner) throw new Error("Oyun bitti");
      if(st.capture){
        if(st.capture.by !== ROLE) throw new Error("Ta≈üƒ± sen alamazsƒ±n");
        if(action.type!=="capture") throw new Error("Ta≈ü almalƒ±sƒ±n");
      }else{
        if(st.turn !== ROLE) throw new Error("Sƒ±ra sende deƒüil");
        if(action.type==="capture") throw new Error("Ta≈ü alma yok");
      }

      const next = applyAction(st, ROLE, action);
      tx.update(ref, { state: next, updatedAt: serverTimestamp() });
    });
  }catch(e){
    setStatus("Hamle olmadƒ±: " + (e?.message || e));
  }
}

function startRoomListener(){
  if(unsubRoom) unsubRoom();
  unsubRoom = onSnapshot(roomRef(ROOM), (snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();
    if(!data?.state) return;
    game = data.state;
    // online‚Äôda pendingMover lokal kalsƒ±n (server‚Äôa gerek yok)
    game.pendingMover = null;
    render();
    setTurnText();
    if(game.winner) showEndOverlay(game.winner);
  });
}

/* ================= AI ================= */
function generateActions(state,p){
  // same action schema but capture handled as separate step in state,
  // so for AI we will still do it in one go by simulating the two-step:
  // place/move -> if capture then choose capture -> apply capture.
  // We'll expand actions into combined actions {main, cap?} but execute them as two internal applies.
  const actions = [];
  if(state.capture){
    if(state.capture.by!==p) return actions;
    for(const at of state.capture.removable){
      actions.push({type:"capture", at});
    }
    return actions;
  }

  const opp = (p==="W")?"B":"W";
  const b = state.board;
  const phase = phaseOf(state,p);

  if(phase==="placing"){
    for(let to=0;to<24;to++){
      if(b[to]!==null) continue;
      actions.push({type:"place", to});
    }
    return actions;
  }

  const fly = canFly(state,p);
  const my = b.map((v,i)=> v===p ? i : -1).filter(i=>i>=0);
  for(const from of my){
    const targets = fly
      ? b.map((v,i)=> v===null ? i : -1).filter(i=>i>=0)
      : ADJ[from].filter(to=>b[to]===null);
    for(const to of targets){
      actions.push({type:"move", from, to});
    }
  }
  return actions;
}

function evalState(state){
  // simple but effective
  if(state.winner==="B") return 1e9;
  if(state.winner==="W") return -1e9;

  const b=state.board;
  const w=countOnBoard(b,"W");
  const bl=countOnBoard(b,"B");
  let score=(bl-w)*100;

  const millsW = MILLS.filter(m=>m.every(i=>b[i]==="W")).length;
  const millsB = MILLS.filter(m=>m.every(i=>b[i]==="B")).length;
  score += (millsB-millsW)*70;

  // capture pending advantage
  if(state.capture){
    score += (state.capture.by==="B") ? 120 : -120;
  }

  // mobility after placement
  if(state.placed.W>=9 && state.placed.B>=9){
    const mob = (p)=>{
      if(canFly(state,p)) return b.filter(x=>x===null).length;
      let moves=0;
      for(let i=0;i<24;i++){
        if(b[i]!==p) continue;
        moves += ADJ[i].filter(j=>b[j]===null).length;
      }
      return moves;
    };
    score += (mob("B")-mob("W"))*5;
  }

  return score;
}

function minimax(state, depth, alpha, beta, maxForB){
  if(depth===0 || state.winner) return {score:evalState(state), action:null};

  const p = maxForB ? "B" : "W";
  const actions = generateActions(state,p);
  if(!actions.length) return {score:evalState(state), action:null};

  // quick ordering
  actions.sort((a,b)=>{
    const ra = (a.type==="capture")? 3 : (a.type==="move")?2:1;
    const rb = (b.type==="capture")? 3 : (b.type==="move")?2:1;
    return rb-ra;
  });

  let bestAction=null;

  if(maxForB){
    let best=-Infinity;
    for(const act of actions){
      let next = JSON.parse(JSON.stringify(state));
      next = applyAction(next, p, act);
      const r = minimax(next, depth-1, alpha, beta, false);
      if(r.score>best){best=r.score;bestAction=act}
      alpha=Math.max(alpha,best);
      if(beta<=alpha) break;
    }
    return {score:best, action:bestAction};
  }else{
    let best=Infinity;
    for(const act of actions){
      let next = JSON.parse(JSON.stringify(state));
      next = applyAction(next, p, act);
      const r = minimax(next, depth-1, alpha, beta, true);
      if(r.score<best){best=r.score;bestAction=act}
      beta=Math.min(beta,best);
      if(beta<=alpha) break;
    }
    return {score:best, action:bestAction};
  }
}

function aiStep(){
  if(MODE!=="AI") return;
  if(game.winner) return;

  // AI is always B
  const p="B";
  if(game.capture){
    if(game.capture.by!=="B") return; // waiting for human capture
  }else{
    if(game.turn!=="B") return;
  }

  setStatus("AI d√º≈ü√ºn√ºyor...");
  setTimeout(()=>{
    const depth = (game.placed.B<9 || game.placed.W<9) ? 3 : 4;
    const {action} = minimax(game, depth, -Infinity, Infinity, true);
    if(!action){
      game.winner = checkWinner(game) || "W";
      render(); setStatus("Oyun bitti."); showEndOverlay(game.winner);
      return;
    }

    game = applyAction(game, "B", action);
    pushHistory();
    render();

    if(game.winner){
      setStatus("Oyun bitti.");
      showEndOverlay(game.winner);
      return;
    }

    // If AI created capture for itself, it will immediately do capture in next tick
    if(game.capture && game.capture.by==="B"){
      setStatus("AI deƒüirmen yaptƒ±. Ta≈ü alacak...");
      aiStep();
    }else{
      setTurnText();
    }
  }, 160);
}

/* ================= Action Dispatcher ================= */
function doAction(action){
  // clear selection locally
  game.pendingMover = null;

  if(MODE==="ONLINE"){
    submitOnlineAction(action);
    return;
  }

  // AI mode: human is W
  try{
    const before = JSON.parse(JSON.stringify(game));
    game = applyAction(game, "W", action);

    // reverse prevention: only for move
    if(action.type==="move") lastHumanMove = {from:action.from, to:action.to};
    else lastHumanMove = null;

    history.push(before); // push "before" for better undo
    $("#undoBtn").disabled = (history.length<=0);

    render();
    if(game.winner){
      setStatus("Oyun bitti.");
      showEndOverlay(game.winner);
      return;
    }
    // If human created capture for itself, wait for capture click (no AI yet)
    if(game.capture && game.capture.by==="W"){
      setStatus("Deƒüirmen! 1 ta≈ü al.");
      return;
    }
    setTurnText();
    aiStep();
  }catch(e){
    setStatus("Hamle olmadƒ±: " + (e?.message || e));
  }
}

/* ================= Undo/Hint (AI) ================= */
function undo(){
  if(MODE!=="AI") return;
  if(history.length<=0) return;
  game = history.pop();
  render();
  setTurnText();
}
function hint(){
  if(MODE!=="AI") return;
  if(game.winner) return;
  if(game.capture && game.capture.by==="W"){
    setStatus("ƒ∞pucu: Alabileceƒüin ta≈ülardan birini se√ß.");
    return;
  }
  if(game.turn!=="W") return;

  const depth = (game.placed.W<9 || game.placed.B<9) ? 3 : 4;
  const {action} = minimax(game, depth, -Infinity, Infinity, false);
  if(!action){ setStatus("ƒ∞pucu bulunamadƒ±."); return; }
  if(action.type==="place") setStatus(`ƒ∞pucu: #${action.to+1} noktasƒ±na ta≈ü koy.`);
  else if(action.type==="move") setStatus(`ƒ∞pucu: #${action.from+1} ‚Üí #${action.to+1}.`);
  else setStatus("ƒ∞pucu: Ta≈ü al.");
}

/* ================= New Game ================= */
async function newGame(){
  hideEndOverlay();

  if(MODE==="AI"){
    game = freshState();
    history = [];
    lastHumanMove = null;
    pushHistory();
    render();
    setStatus("Sƒ±ra sende. Bo≈ü bir noktaya ta≈ü koy.");
    return;
  }

  // Online: only Host can reset
  if(ROLE!=="W"){
    setStatus("Online‚Äôda yeni oyunu sadece Host (Turuncu) ba≈ülatabilir.");
    return;
  }
  try{
    await updateDoc(roomRef(ROOM), { state: freshState(), updatedAt: serverTimestamp() });
    setStatus("Yeni oyun ba≈ülatƒ±ldƒ±.");
  }catch(e){
    setStatus("Yeni oyun hatasƒ±: " + (e?.message || e));
  }
}

/* ================= Online Room ================= */
function randInt(n){
  if (window.crypto && crypto.getRandomValues){
    const a=new Uint32Array(1); crypto.getRandomValues(a);
    return a[0]%n;
  }
  return Math.floor(Math.random()*n);
}
function genRoomCode(){
  const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s=""; for(let i=0;i<6;i++) s+=chars[randInt(chars.length)];
  return s;
}

async function createRoom(){
  if(!profileOK()) return;
  MODE="ONLINE"; ROLE="W"; ROOM=genRoomCode();

  try{
    await setDoc(roomRef(ROOM), {
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      state: freshState()
    });
    setLoginMsg("Oda olu≈üturuldu.\nKOD: " + ROOM + "\nRakibe bu kodu g√∂nder.");
    openGameUI();
    startRoomListener();
    render();
    setStatus("Rakip kodla girince ba≈ülayabilirsiniz.");
    setTurnText();
  }catch(e){
    setLoginMsg("ODA OLU≈ûTURMA HATASI:\n" + (e?.message || e));
  }
}

async function joinRoom(){
  if(!profileOK()) return;
  MODE="ONLINE"; ROLE="B";
  ROOM = ($("#roomCode").value||"").trim().toUpperCase();
  if(!ROOM){ setLoginMsg("Oda kodu gir."); return; }

  try{
    const snap = await getDoc(roomRef(ROOM));
    if(!snap.exists()){
      setLoginMsg("ODA BULUNAMADI. Kodu kontrol et.");
      return;
    }
    openGameUI();
    startRoomListener();
    render();
    setStatus("Odaya katƒ±ldƒ±n. Sƒ±ra Turuncu ile ba≈ülar.");
    setTurnText();
  }catch(e){
    setLoginMsg("KATILMA HATASI:\n" + (e?.message || e));
  }
}

/* ================= UI Buttons ================= */
$("#toggleOnline").addEventListener("click", ()=>{
  const p=$("#onlinePanel");
  p.style.display = (p.style.display==="none" ? "block" : "none");
});

$("#startAI").addEventListener("click", ()=>{
  if(!profileOK()) return;
  MODE="AI"; ROLE="W"; ROOM=null;
  if(unsubRoom){ unsubRoom(); unsubRoom=null; }
  openGameUI();
  game = freshState();
  history = [];
  lastHumanMove = null;
  pushHistory();
  render();
  setStatus("Sƒ±ra sende. Bo≈ü bir noktaya ta≈ü koy.");
});

$("#createRoom").addEventListener("click", createRoom);
$("#joinRoomBtn").addEventListener("click", joinRoom);

$("#newBtn").addEventListener("click", newGame);
$("#undoBtn").addEventListener("click", undo);
$("#hintBtn").addEventListener("click", hint);

$("#leaveBtn").addEventListener("click", ()=>{
  if(unsubRoom){ unsubRoom(); unsubRoom=null; }
  MODE=null; ROLE="W"; ROOM=null;
  game=freshState(); history=[];
  setLoginMsg(""); setLoginMsgMain("");
  openLoginUI();
});

/* ================= Initial Render ================= */
function pushHistory(){ history.push(JSON.parse(JSON.stringify(game))); $("#undoBtn").disabled=(history.length<=1); }

game=freshState();
render();
setLoginMsgMain("Mod se√ßip ba≈ülayabilirsin.");
setTurnText();
</script>
</body>
</html>
